<view class="page">
  <view class="header">
    <text class="title font-ancient">专业排盘</text>
    <text class="subtitle">精密星历计算引擎</text>
  </view>

  <view class="content">
    <block wx:if="{{resultStatus === 'idle'}}">
      <view class="card ink-border animate-in">
        <view class="label-row">
          <text class="section-label">排盘类型</text>
        </view>
        <picker mode="selector" range="{{chartTypes}}" range-key="label" value="{{selectedTypeIndex}}" bindchange="handleTypeChange">
          <view class="picker-display ink-border">
            <text class="picker-text">{{selectedType.label}}</text>
            <view class="picker-arrow"></view>
          </view>
        </picker>
        <text class="type-desc">{{selectedType.desc}}</text>
      </view>

      <view class="card ink-border animate-in delay-1">
        <view class="section-header">
          <text class="section-title font-ancient">{{selectedType.dual ? '甲方资料' : '资料录入'}}</text>
        </view>
        
        <view class="input-group">
          <text class="label">姓名</text>
          <input class="input ink-border" placeholder="请输入..." placeholder-class="placeholder-text" data-person="personA" data-field="name" bindinput="handleInput" value="{{personA.name}}"/>
        </view>
        
        <view class="row">
          <view class="col">
            <text class="label">日期</text>
            <picker mode="date" data-person="personA" data-field="date" bindchange="handleInput" value="{{personA.date}}">
               <view class="input ink-border picker-input">{{personA.date}}</view>
            </picker>
          </view>
          <view class="col">
            <text class="label">时间</text>
             <picker mode="time" data-person="personA" data-field="time" bindchange="handleInput" value="{{personA.time}}">
               <view class="input ink-border picker-input">{{personA.time}}</view>
            </picker>
          </view>
        </view>

        <view class="input-group city-input-group">
          <text class="label">城市</text>
          <view class="city-input-wrapper">
            <input class="input ink-border" placeholder="输入城市名、拼音或首字母" placeholder-class="placeholder-text" data-person="personA" bindinput="handleCityInput" bindfocus="handleCityFocus" bindblur="handleCityBlur" value="{{personA.city}}"/>
            <view class="city-dropdown" wx:if="{{showCityDropdownA && citySuggestionsA.length > 0}}">
              <view class="city-dropdown-item" wx:for="{{citySuggestionsA}}" wx:key="id" bindtap="selectCity" data-person="personA" data-city="{{item}}">
                <text class="city-name">{{item.name}}</text>
                <text class="city-region">{{item.province}}, {{item.country}}</text>
              </view>
            </view>
            <view class="city-dropdown city-no-result" wx:if="{{showCityDropdownA && citySuggestionsA.length === 0 && personA.city}}">
              <text>未找到匹配城市</text>
            </view>
          </view>
        </view>

        <block wx:if="{{selectedType.dual}}">
           <view class="section-header">
            <text class="section-title font-ancient">乙方资料</text>
          </view>
          
          <view class="input-group">
            <text class="label">姓名</text>
            <input class="input ink-border" placeholder="请输入..." placeholder-class="placeholder-text" data-person="personB" data-field="name" bindinput="handleInput" value="{{personB.name}}"/>
          </view>
          
          <view class="row">
            <view class="col">
              <text class="label">日期</text>
              <picker mode="date" data-person="personB" data-field="date" bindchange="handleInput" value="{{personB.date}}">
                 <view class="input ink-border picker-input">{{personB.date}}</view>
              </picker>
            </view>
            <view class="col">
              <text class="label">时间</text>
               <picker mode="time" data-person="personB" data-field="time" bindchange="handleInput" value="{{personB.time}}">
                 <view class="input ink-border picker-input">{{personB.time}}</view>
              </picker>
            </view>
          </view>

          <view class="input-group city-input-group">
            <text class="label">城市</text>
            <view class="city-input-wrapper">
              <input class="input ink-border" placeholder="输入城市名、拼音或首字母" placeholder-class="placeholder-text" data-person="personB" bindinput="handleCityInput" bindfocus="handleCityFocus" bindblur="handleCityBlur" value="{{personB.city}}"/>
              <view class="city-dropdown" wx:if="{{showCityDropdownB && citySuggestionsB.length > 0}}">
                <view class="city-dropdown-item" wx:for="{{citySuggestionsB}}" wx:key="id" bindtap="selectCity" data-person="personB" data-city="{{item}}">
                  <text class="city-name">{{item.name}}</text>
                  <text class="city-region">{{item.province}}, {{item.country}}</text>
                </view>
              </view>
              <view class="city-dropdown city-no-result" wx:if="{{showCityDropdownB && citySuggestionsB.length === 0 && personB.city}}">
                <text>未找到匹配城市</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </block>

    <block wx:else>
      <view class="card animate-in" wx:if="{{resultStatus === 'unsupported'}}">
        <view class="result-header">
          <text class="result-title">{{resultTitle}}</text>
          <view class="tags">
            <text class="tag">开发中</text>
          </view>
        </view>
        <view class="empty-state">
          <text>{{unsupportedMessage}}</text>
        </view>
      </view>

      <block wx:elif="{{resultStatus === 'ready'}}">
        <view class="card ink-border animate-in">
          <view class="result-header">
             <text class="result-title font-ancient">{{resultTitle}}</text>
          </view>
          <view class="chart-wrapper">
            <astro-chart
              type="{{chartType}}"
              positions="{{chartPositions}}"
              outerPositions="{{outerPositions}}"
              aspects="{{chartAspects}}"
              houseCusps="{{chartHouseCusps}}"
              width="{{chartSize}}"
              height="{{chartSize}}"
            ></astro-chart>
          </view>
          <text class="chart-desc" wx:if="{{chartDesc}}">{{chartDesc}}</text>
        </view>

        <view class="accordion-item ink-border" wx:if="{{!isDualResult}}">
          <view class="accordion-head" bindtap="toggleAccordion" data-id="elements">
            <text class="accordion-label">元素矩阵</text>
            <text class="accordion-icon">{{expandedSection === 'elements' ? '-' : '+'}}</text>
          </view>
          <view class="accordion-body" wx:if="{{expandedSection === 'elements'}}" style="padding: 0;">
            <view class="element-table">
              <view class="el-row el-head font-ancient">
                <view class="el-cell"></view>
                <view class="el-cell">开创</view>
                <view class="el-cell">固定</view>
                <view class="el-cell">变动</view>
              </view>

              
              <view class="el-row">
                <view class="el-cell el-label" style="color: #FF4D4F">火</view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.fire.cardinal}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.fire.cardinal.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.fire.fixed}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.fire.fixed.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.fire.mutable}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.fire.mutable.length === 0}}" class="empty-dash">-</text>
                </view>
              </view>

              <view class="el-row">
                <view class="el-cell el-label" style="color: #C6A062">土</view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.earth.cardinal}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.earth.cardinal.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.earth.fixed}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.earth.fixed.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.earth.mutable}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.earth.mutable.length === 0}}" class="empty-dash">-</text>
                </view>
              </view>

              <view class="el-row">
                <view class="el-cell el-label" style="color: #40A9FF">风</view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.air.cardinal}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.air.cardinal.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.air.fixed}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.air.fixed.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.air.mutable}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.air.mutable.length === 0}}" class="empty-dash">-</text>
                </view>
              </view>

              <view class="el-row">
                <view class="el-cell el-label" style="color: #52C41A">水</view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.water.cardinal}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.water.cardinal.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.water.fixed}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.water.fixed.length === 0}}" class="empty-dash">-</text>
                </view>
                <view class="el-cell">
                  <view class="planet-capsule" wx:for="{{elementMatrix.water.mutable}}" wx:key="id" style="color: {{item.color}}">{{item.symbol}}</view>
                  <text wx:if="{{elementMatrix.water.mutable.length === 0}}" class="empty-dash">-</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <view class="accordion-item ink-border">
          <view class="accordion-head" bindtap="toggleAccordion" data-id="aspects">
            <text class="accordion-label">相位矩阵</text>
            <text class="accordion-icon">{{expandedSection === 'aspects' ? '-' : '+'}}</text>
          </view>
          <view class="accordion-body" wx:if="{{expandedSection === 'aspects'}}" style="padding: 0;">
            <view class="aspect-matrix-container {{isDualResult ? 'dual-matrix' : ''}}">
              <!-- 固定左侧列（行标题） -->
              <view class="matrix-fixed-col">
                <view wx:for="{{aspectMatrix}}" wx:for-item="row" wx:for-index="i" wx:key="i">
                  <view class="matrix-cell {{row[0].isHeader ? 'cell-header font-ancient' : ''}} {{row[0].isEmpty ? 'cell-empty' : ''}}">
                    <view wx:if="{{row[0].isEmpty && isDualResult}}" class="matrix-corner">
                      <text class="matrix-corner-a">甲→</text>
                      <text class="matrix-corner-b">↓乙</text>
                    </view>
                    <text wx:elif="{{row[0].isHeader}}" class="p-symbol">{{row[0].symbol}}</text>
                  </view>
                </view>
              </view>
              <!-- 可滚动区域 -->
              <scroll-view scroll-x class="matrix-scroll-area" enable-flex show-scrollbar="false">
                <view class="aspect-matrix">
                  <view wx:for="{{aspectMatrix}}" wx:for-item="row" wx:for-index="i" wx:key="i" class="matrix-row">
                    <view wx:for="{{row}}" wx:for-item="cell" wx:for-index="j" wx:key="j" wx:if="{{j > 0}}" class="matrix-cell {{cell.isHeader ? 'cell-header font-ancient' : ''}} {{cell.isEmpty ? 'cell-empty' : ''}}">
                      <text wx:if="{{cell.isHeader}}" class="p-symbol">{{cell.symbol}}</text>
                      <view wx:elif="{{cell.aspect}}" class="a-info">
                        <text class="a-symbol" style="color: {{cell.aspect.color}}">{{cell.aspect.symbol}}</text>
                        <text class="a-orb">{{cell.aspect.orbText}}</text>
                      </view>
                    </view>
                  </view>
                </view>
              </scroll-view>
            </view>
          </view>
        </view>

        <view class="accordion-item ink-border">
          <view class="accordion-head" bindtap="toggleAccordion" data-id="planets">
            <text class="accordion-label">行星信息</text>
            <text class="accordion-icon">{{expandedSection === 'planets' ? '-' : '+'}}</text>
          </view>
          <view class="accordion-body" wx:if="{{expandedSection === 'planets'}}" style="padding: 0;">
            <block wx:for="{{planetGroups}}" wx:for-item="group" wx:for-index="groupIndex" wx:key="id">
              <view class="section-sub-header {{groupIndex > 0 ? 'margin-top-lg' : ''}}" wx:if="{{planetGroups.length > 1}}">
                <text class="sub-title font-ancient">{{group.title}}</text>
              </view>
              <view class="planet-info-table">
                <view class="pi-row pi-head font-ancient">
                  <view class="pi-cell pi-planet">星体</view>
                  <view class="pi-cell pi-sign">星座</view>
                  <view class="pi-cell pi-house">宫位</view>
                  <view class="pi-cell pi-retro">逆行</view>
                </view>
                <block wx:for="{{group.list}}" wx:key="id">
                  <view class="pi-row">
                    <view class="pi-cell pi-planet">
                      <view class="pi-icon-circle">
                         <text class="glyph" style="color: {{item.color}}">{{item.symbol}}</text>
                      </view>
                      <text class="pi-name">{{item.name}}</text>
                    </view>
                    <view class="pi-cell pi-sign">
                      <view class="pi-icon-circle mini">
                         <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
                      </view>
                      <view class="pi-sign-info">
                        <text class="pi-sign-name" style="color: {{item.color}}">{{item.sign}}</text>
                        <text class="pi-degree">{{item.degree}}</text>
                      </view>
                    </view>
                    <view class="pi-cell pi-house">{{item.house}}宫</view>
                    <view class="pi-cell pi-retro">
                      <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
                      <text wx:else class="retro-none">-</text>
                    </view>
                  </view>
                </block>
              </view>
            </block>
          </view>
        </view>

        <view class="accordion-item ink-border">
          <view class="accordion-head" bindtap="toggleAccordion" data-id="asteroids">
            <text class="accordion-label">小行星信息</text>
            <text class="accordion-icon">{{expandedSection === 'asteroids' ? '-' : '+'}}</text>
          </view>
          <view class="accordion-body" wx:if="{{expandedSection === 'asteroids'}}" style="padding: 0;">
            <block wx:for="{{asteroidGroups}}" wx:for-item="group" wx:for-index="groupIndex" wx:key="id">
              <view class="section-sub-header {{groupIndex > 0 ? 'margin-top-lg' : ''}}" wx:if="{{asteroidGroups.length > 1}}">
                <text class="sub-title font-ancient">{{group.title}}</text>
              </view>
              <view class="planet-info-table">
                <view class="pi-row pi-head font-ancient">
                  <view class="pi-cell pi-planet">星体</view>
                  <view class="pi-cell pi-sign">星座</view>
                  <view class="pi-cell pi-house">宫位</view>
                  <view class="pi-cell pi-retro">逆行</view>
                </view>
                <block wx:for="{{group.list}}" wx:key="id">
                  <view class="pi-row">
                    <view class="pi-cell pi-planet">
                      <view class="pi-icon-circle">
                         <text class="glyph" style="color: {{item.color}}">{{item.symbol}}</text>
                      </view>
                      <text class="pi-name">{{item.name}}</text>
                    </view>
                    <view class="pi-cell pi-sign">
                      <view class="pi-icon-circle mini">
                         <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
                      </view>
                      <view class="pi-sign-info">
                        <text class="pi-sign-name" style="color: {{item.color}}">{{item.sign}}</text>
                        <text class="pi-degree">{{item.degree}}</text>
                      </view>
                    </view>
                    <view class="pi-cell pi-house">{{item.house}}宫</view>
                    <view class="pi-cell pi-retro">
                      <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
                      <text wx:else class="retro-none">-</text>
                    </view>
                  </view>
                </block>
              </view>
            </block>
          </view>
        </view>

        <view class="accordion-item ink-border">
          <view class="accordion-head" bindtap="toggleAccordion" data-id="houseRulers">
            <text class="accordion-label">宫主星信息</text>
            <text class="accordion-icon">{{expandedSection === 'houseRulers' ? '-' : '+'}}</text>
          </view>
          <view class="accordion-body" wx:if="{{expandedSection === 'houseRulers'}}" style="padding: 0;">
            <block wx:for="{{houseRulerGroups}}" wx:for-item="group" wx:for-index="groupIndex" wx:key="id">
              <view class="section-sub-header {{groupIndex > 0 ? 'margin-top-lg' : ''}}" wx:if="{{houseRulerGroups.length > 1}}">
                <text class="sub-title font-ancient">{{group.title}}</text>
              </view>
              <view class="planet-info-table">
                <view class="pi-row pi-head font-ancient">
                  <view class="pi-cell pi-hr-house">宫位</view>
                  <view class="pi-cell pi-hr-sign">星座</view>
                  <view class="pi-cell pi-hr-ruler">宫主星</view>
                  <view class="pi-cell pi-hr-arrow"></view>
                  <view class="pi-cell pi-hr-fly">飞入宫位</view>
                </view>
                <block wx:for="{{group.list}}" wx:key="house">
                  <view class="pi-row">
                    <view class="pi-cell pi-hr-house">{{item.house}}</view>
                    <view class="pi-cell pi-hr-sign">
                      <view class="pi-icon-circle mini">
                        <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
                      </view>
                      <text class="pi-sign-name" style="color: {{item.signColor}}">{{item.signName}}</text>
                    </view>
                    <view class="pi-cell pi-hr-ruler">
                      <view class="pi-icon-circle mini">
                         <text class="glyph-small" style="color: {{item.rulerColor}}">{{item.rulerGlyph}}</text>
                      </view>
                      <text class="pi-name">{{item.rulerName}}</text>
                    </view>
                    <view class="pi-cell pi-hr-arrow"></view>
                    <view class="pi-cell pi-hr-fly">
                      <view class="fly-capsule ink-border">
                        <text class="fly-arrow">→</text>
                        <image class="pi-icon mini-fly" src="{{item.fliesToSignIcon}}" mode="aspectFit"></image>
                        <text class="fly-text" style="color: {{item.fliesToSignColor}}">{{item.fliesToSignName}}</text>
                        <text class="fly-house">{{item.fliesToHouse}}宫</text>
                      </view>
                    </view>
                  </view>
                </block>
              </view>
            </block>
          </view>
        </view>
      </block>
    </block>
    
    <view class="footer-spacer"></view>
  </view>

  <view class="footer">
    <button class="action-btn {{loading ? 'loading' : ''}}" bindtap="{{resultStatus === 'idle' ? 'generateChart' : 'resetResult'}}" disabled="{{loading}}">
       {{resultStatus === 'idle' ? (loading ? '正在计算...' : '生成专业图谱') : '再次生成'}}
    </button>
  </view>

  <!-- 全屏加载遮罩 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在计算星历...</text>
      <text class="loading-hint">基于瑞士星历表精密计算</text>
    </view>
  </view>
</view>
