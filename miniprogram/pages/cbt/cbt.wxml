<view class="page-root">

  <!-- ===== DASHBOARD ===== -->
  <scroll-view wx:if="{{viewMode === 'dashboard'}}" scroll-y class="content-scroll" show-scrollbar="{{false}}">
    <view class="dashboard-content">

      <view class="page-header">
        <text class="page-title font-ancient">心情日记</text>
        <text class="page-subtitle">记录此刻，星象为你解读</text>
      </view>

      <!-- 日历 -->
      <view class="calendar-card ink-border">
        <view class="calendar-header">
          <text class="month-title font-ancient">{{currentMonth}}</text>
        </view>
        <view class="calendar-weekdays">
          <text wx:for="{{weekDays}}" wx:key="*this" class="weekday-label">{{item}}</text>
        </view>
        <view class="calendar-grid">
          <block wx:for="{{calendarDays}}" wx:key="id">
            <view class="day-cell {{item.empty ? 'empty' : ''}}">
              <view wx:if="{{!item.empty}}" class="day-content {{item.isCurrent ? 'current' : ''}}" style="opacity: {{item.opacity}}">
                <view wx:if="{{item.moodId}}" class="mood-dot mood-group-{{item.moodGroup || 'calm'}}"></view>
                <text wx:else class="day-number">{{item.day}}</text>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 历史记录 -->
      <view wx:if="{{history.length > 0}}" class="history-section">
        <text class="section-label font-ancient">历史记录</text>
        <block wx:for="{{history}}" wx:key="id">
          <view class="history-item ink-border">
            <view class="history-top">
              <text class="history-mood font-ancient">{{item.moodLabel}}</text>
              <text class="history-time">{{item.date}}</text>
            </view>
            <text class="history-summary">{{item.summary}}</text>
          </view>
        </block>
      </view>

      <view wx:else class="empty-state">
        <text class="empty-text">还没有记录</text>
        <text class="empty-hint">记录第一篇心情日记吧</text>
      </view>

      <view class="scroll-bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- ===== 记录流程（单页滚动） ===== -->
  <scroll-view wx:elif="{{viewMode === 'record'}}" scroll-y class="content-scroll" show-scrollbar="{{false}}">
    <view class="record-content">

      <!-- ① 心情选择（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">今天心情怎么样？</text>
        <view class="mood-group-grid">
          <block wx:for="{{moodGroups}}" wx:key="id">
            <view
              class="mood-group-item {{record.moodGroup === item.id ? 'selected' : ''}}"
              bindtap="onMoodGroupTap"
              data-id="{{item.id}}"
            >
              <text class="mood-group-emoji">{{item.emoji}}</text>
              <text class="mood-group-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ② 情绪细分（多选） -->
      <view wx:if="{{record.moodGroup}}" class="section-block fade-in">
        <text class="section-title font-ancient">具体是哪些感觉？</text>
        <text class="section-hint">可以选多个</text>

        <!-- 当前选中组的情绪（自动展开） -->
        <view class="mood-detail-grid">
          <block wx:for="{{currentMoodItems}}" wx:key="id">
            <view
              class="mood-detail-item {{record.moods.indexOf(item.id) >= 0 ? 'selected' : ''}}"
              bindtap="onMoodToggle"
              data-id="{{item.id}}"
            >
              <text class="mood-detail-emoji">{{item.emoji}}</text>
              <text class="mood-detail-label">{{item.label}}</text>
              <text class="mood-detail-desc">{{item.desc}}</text>
            </view>
          </block>
        </view>

        <!-- 其他组折叠展开 -->
        <block wx:for="{{moodGroups}}" wx:key="id">
          <block wx:if="{{item.id !== record.moodGroup}}">
            <view
              class="other-group-header"
              bindtap="toggleMoodGroup"
              data-group="{{item.id}}"
            >
              <text class="other-group-label">{{item.emoji}} {{item.label}}</text>
              <text class="group-arrow {{expandedGroup === item.id ? 'open' : ''}}">›</text>
            </view>
            <view wx:if="{{expandedGroup === item.id}}" class="mood-detail-grid fade-in">
              <block wx:for="{{expandedMoodItems}}" wx:for-item="mood" wx:key="id">
                <view
                  class="mood-detail-item {{record.moods.indexOf(mood.id) >= 0 ? 'selected' : ''}}"
                  bindtap="onMoodToggle"
                  data-id="{{mood.id}}"
                >
                  <text class="mood-detail-emoji">{{mood.emoji}}</text>
                  <text class="mood-detail-label">{{mood.label}}</text>
                  <text class="mood-detail-desc">{{mood.desc}}</text>
                </view>
              </block>
            </view>
          </block>
        </block>
      </view>

      <!-- ③ 场景标签（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">因为什么呢？</text>
        <view class="tag-grid">
          <block wx:for="{{sceneTags}}" wx:key="id">
            <view
              class="tag-item {{record.scene === item.id ? 'selected' : ''}}"
              bindtap="onSceneTap"
              data-id="{{item.id}}"
            >
              <text class="tag-emoji">{{item.emoji}}</text>
              <text class="tag-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ④ 睡眠质量（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">昨晚睡得怎么样？</text>
        <view class="sleep-grid">
          <block wx:for="{{sleepTags}}" wx:key="id">
            <view
              class="sleep-item {{record.sleep === item.id ? 'selected' : ''}}"
              bindtap="onSleepTap"
              data-id="{{item.id}}"
            >
              <text class="sleep-emoji">{{item.emoji}}</text>
              <text class="sleep-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ⑤ 身体状态（可选，多选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">身体感觉如何？</text>
        <text class="section-hint">选填，可多选</text>
        <view class="tag-grid">
          <block wx:for="{{bodyTags}}" wx:key="id">
            <view
              class="tag-item {{record.bodyTags.indexOf(item.id) >= 0 ? 'selected' : ''}}"
              bindtap="onBodyToggle"
              data-id="{{item.id}}"
            >
              <text class="tag-emoji">{{item.emoji}}</text>
              <text class="tag-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ⑥ 补充文字（可选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">还想说点什么吗？</text>
        <text class="section-hint">选填</text>
        <input
          class="note-input ink-border"
          placeholder="想说点什么..."
          value="{{record.note}}"
          bindinput="onNoteInput"
          maxlength="100"
        />
      </view>

      <!-- AI 解读结果 -->
      <view wx:if="{{showResult}}" class="section-block fade-in">
        <view class="analysis-card ink-border">
          <view class="analysis-header">
            <text class="analysis-badge">星智</text>
            <text class="analysis-title">星象解读</text>
          </view>
          <view wx:if="{{analyzing}}" class="loading-state">
            <view class="spinner"></view>
            <text class="loading-text">星象解读中...</text>
          </view>
          <view wx:else class="analysis-body">
            <text class="analysis-text">{{analysis}}</text>
          </view>
        </view>
      </view>

      <view class="scroll-bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- ===== 底部栏 ===== -->
  <view class="bottom-bar">
    <view class="bottom-bar-inner">
      <block wx:if="{{viewMode === 'dashboard'}}">
        <button class="action-btn primary-btn" bindtap="startRecord">
          <text>记录心情</text>
        </button>
      </block>

      <block wx:elif="{{viewMode === 'record'}}">
        <block wx:if="{{showResult && !analyzing}}">
          <button class="action-btn primary-btn" bindtap="completeAndReturn">好的</button>
        </block>
        <block wx:elif="{{!showResult}}">
          <button class="action-btn secondary-btn" bindtap="exitRecord">算了</button>
          <button class="action-btn primary-btn flex-grow" bindtap="submitRecord">记录完成</button>
        </block>
      </block>
    </view>
  </view>
</view>
