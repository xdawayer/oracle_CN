<view class="page-root">

  <!-- ===== DASHBOARD ===== -->
  <scroll-view wx:if="{{viewMode === 'dashboard'}}" scroll-y class="content-scroll" show-scrollbar="{{false}}">
    <view class="dashboard-content">

      <view class="page-header">
        <text class="page-title font-ancient">心情日记</text>
        <text class="page-subtitle">记录此刻，星象为你解读</text>
      </view>

      <!-- 日历 -->
      <view class="calendar-card ink-border">
        <view class="calendar-header">
          <text class="month-title font-ancient">{{currentMonth}}</text>
        </view>
        <view class="calendar-weekdays">
          <text wx:for="{{weekDays}}" wx:key="*this" class="weekday-label">{{item}}</text>
        </view>
        <view class="calendar-grid">
          <block wx:for="{{calendarDays}}" wx:key="id">
            <view class="day-cell {{item.empty ? 'empty' : ''}}">
              <view wx:if="{{!item.empty}}" class="day-content {{item.isCurrent ? 'current' : ''}}" style="opacity: {{item.opacity}}">
                <view wx:if="{{item.moodId}}" class="mood-dot mood-group-{{item.moodGroup || 'calm'}}"></view>
                <text wx:else class="day-number">{{item.day}}</text>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 历史记录卡片 -->
      <view wx:if="{{history.length > 0}}" class="history-section">
        <block wx:for="{{history}}" wx:key="id">

          <!-- 记录卡片 -->
          <view wx:if="{{item.type === 'record'}}" class="history-card">
            <view class="history-card-main">
              <text class="history-card-emoji">{{item.data.moodGroupEmoji}}</text>
              <view class="history-card-info">
                <text class="history-card-date">{{item.data.weekDay}}, {{item.data.dateStr}}</text>
                <view class="history-card-mood-row">
                  <text class="history-card-mood-label mood-color-{{item.data.moodGroupId}}">{{item.data.moodGroupLabel}}</text>
                  <text class="history-card-time">{{item.data.timeStr}}</text>
                </view>
              </view>
            </view>
            <view wx:if="{{item.data.detailTags.length > 0}}" class="history-card-tags">
              <block wx:for="{{item.data.detailTags}}" wx:for-item="tag" wx:key="label">
                <text class="history-tag">{{tag.emoji}} {{tag.label}}</text>
                <text wx:if="{{index < item.data.detailTags.length - 1}}" class="history-tag-dot">·</text>
              </block>
            </view>
          </view>

          <!-- 缺少天数间隔 -->
          <view wx:elif="{{item.type === 'gap'}}" class="history-gap">
            <text class="history-gap-text">缺少{{item.days}}天</text>
          </view>

        </block>
      </view>

      <view wx:else class="empty-state">
        <text class="empty-text">还没有记录</text>
        <text class="empty-hint">记录第一篇心情日记吧</text>
      </view>

      <view class="scroll-bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- ===== 记录流程（单页滚动） ===== -->
  <scroll-view wx:elif="{{viewMode === 'record'}}" scroll-y class="content-scroll" show-scrollbar="{{false}}">
    <view class="record-content">

      <!-- ① 心情选择（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">今天心情怎么样？</text>
        <view class="mood-group-grid">
          <block wx:for="{{moodGroups}}" wx:key="id">
            <view
              class="mood-group-item {{record.moodGroup === item.id ? 'selected' : ''}}"
              bindtap="onMoodGroupTap"
              data-id="{{item.id}}"
            >
              <text class="mood-group-emoji">{{item.emoji}}</text>
              <text class="mood-group-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ② 情绪细分（多选） -->
      <view wx:if="{{record.moodGroup}}" class="section-block fade-in">
        <text class="section-title font-ancient">具体是哪些感觉？</text>
        <text class="section-hint">可以选多个</text>

        <!-- 当前选中组的情绪（自动展开） -->
        <view class="mood-detail-grid">
          <block wx:for="{{currentMoodItems}}" wx:key="id">
            <view
              class="mood-detail-item {{selectedMoodsMap[item.id] ? 'selected' : ''}}"
              bindtap="onMoodToggle"
              data-id="{{item.id}}"
            >
              <text class="mood-detail-emoji">{{item.emoji}}</text>
              <text class="mood-detail-label">{{item.label}}</text>
              <text class="mood-detail-desc">{{item.desc}}</text>
            </view>
          </block>
        </view>

        <!-- 其他组折叠展开 -->
        <block wx:for="{{moodGroups}}" wx:key="id">
          <block wx:if="{{item.id !== record.moodGroup}}">
            <view
              class="other-group-header"
              bindtap="toggleMoodGroup"
              data-group="{{item.id}}"
            >
              <text class="other-group-label">{{item.emoji}} {{item.label}}</text>
              <text class="group-arrow {{expandedGroup === item.id ? 'open' : ''}}">›</text>
            </view>
            <view wx:if="{{expandedGroup === item.id}}" class="mood-detail-grid fade-in">
              <block wx:for="{{expandedMoodItems}}" wx:for-item="mood" wx:key="id">
                <view
                  class="mood-detail-item {{selectedMoodsMap[mood.id] ? 'selected' : ''}}"
                  bindtap="onMoodToggle"
                  data-id="{{mood.id}}"
                >
                  <text class="mood-detail-emoji">{{mood.emoji}}</text>
                  <text class="mood-detail-label">{{mood.label}}</text>
                  <text class="mood-detail-desc">{{mood.desc}}</text>
                </view>
              </block>
            </view>
          </block>
        </block>
      </view>

      <!-- ③ 场景标签（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">因为什么呢？</text>
        <view class="tag-grid">
          <block wx:for="{{sceneTags}}" wx:key="id">
            <view
              class="tag-item {{record.scene === item.id ? 'selected' : ''}}"
              bindtap="onSceneTap"
              data-id="{{item.id}}"
            >
              <text class="tag-emoji">{{item.emoji}}</text>
              <text class="tag-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ④ 睡眠质量（单选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">昨晚睡得怎么样？</text>
        <view class="sleep-grid">
          <block wx:for="{{sleepTags}}" wx:key="id">
            <view
              class="sleep-item {{record.sleep === item.id ? 'selected' : ''}}"
              bindtap="onSleepTap"
              data-id="{{item.id}}"
            >
              <text class="sleep-emoji">{{item.emoji}}</text>
              <text class="sleep-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ⑤ 身体状态（可选，多选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">身体感觉如何？</text>
        <text class="section-hint">选填，可多选</text>
        <view class="tag-grid">
          <block wx:for="{{bodyTags}}" wx:key="id">
            <view
              class="tag-item {{selectedBodyMap[item.id] ? 'selected' : ''}}"
              bindtap="onBodyToggle"
              data-id="{{item.id}}"
            >
              <text class="tag-emoji">{{item.emoji}}</text>
              <text class="tag-label">{{item.label}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- ⑥ 补充文字（可选） -->
      <view class="section-block fade-in">
        <text class="section-title font-ancient">还想说点什么吗？</text>
        <text wx:if="{{!record.note}}" class="section-hint">选填</text>
        <textarea
          class="note-textarea ink-border"
          placeholder="想说点什么..."
          value="{{record.note}}"
          bindblur="onNoteInput"
          maxlength="200"
          auto-height
        ></textarea>
      </view>

      <view class="scroll-bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- ===== 全屏报告视图 ===== -->
  <scroll-view wx:elif="{{viewMode === 'result'}}" scroll-y class="content-scroll" show-scrollbar="{{false}}">
    <view class="result-content">

      <!-- Loading 状态 -->
      <view wx:if="{{analyzing}}" class="result-loading fade-in">
        <view class="spinner"></view>
        <text class="loading-text">星象解读中...</text>
      </view>

      <!-- 报告内容 -->
      <block wx:else>
        <!-- 报告头部 -->
        <view class="result-header fade-in">
          <text class="result-header-emoji">{{recordSummary.moodEmoji}}</text>
          <text class="result-header-title font-ancient">心情报告</text>
          <text class="result-header-date">{{recordSummary.date}}</text>
        </view>

        <!-- 记录摘要卡片 -->
        <view wx:if="{{recordSummary}}" class="record-summary ink-border fade-in">
          <text class="summary-title font-ancient">今日记录</text>
          <view class="summary-row">
            <text>{{recordSummary.moodEmoji}} {{recordSummary.moodLabels}}</text>
          </view>
          <view wx:if="{{recordSummary.sceneLabel}}" class="summary-row">
            <text>{{recordSummary.sceneEmoji}} {{recordSummary.sceneLabel}}</text>
          </view>
          <view wx:if="{{recordSummary.sleepLabel}}" class="summary-row">
            <text>{{recordSummary.sleepEmoji}} {{recordSummary.sleepLabel}}</text>
          </view>
          <view wx:if="{{recordSummary.bodyLabels.length > 0}}" class="summary-row">
            <block wx:for="{{recordSummary.bodyLabels}}" wx:key="label">
              <text class="summary-body-tag">{{item.emoji}} {{item.label}}</text>
            </block>
          </view>
          <view wx:if="{{recordSummary.note}}" class="summary-row summary-note">
            <text>"{{recordSummary.note}}"</text>
          </view>
        </view>

        <!-- Sections 循环渲染 -->
        <block wx:if="{{reportData && reportData.sections}}" wx:for="{{reportData.sections}}" wx:key="index">

          <!-- mood_echo: 共情回应 -->
          <view wx:if="{{item.type === 'mood_echo'}}" class="report-section fade-in">
            <text class="report-section-title font-ancient">{{item.title}}</text>
            <view class="report-card ink-border">
              <text class="card-content">{{item.content}}</text>
            </view>
          </view>

          <!-- astro_insight: 星象解读 -->
          <view wx:elif="{{item.type === 'astro_insight'}}" class="report-section fade-in">
            <text class="report-section-title font-ancient">{{item.title}}</text>
            <block wx:if="{{item.cards && item.cards.length > 0}}" wx:for="{{item.cards}}" wx:for-item="card" wx:key="title">
              <view class="report-card ink-border">
                <text class="card-title font-ancient">{{card.title}}</text>
                <text class="card-content">{{card.content}}</text>
                <view wx:if="{{card.astroBasis}}" class="card-astro-basis">
                  <text class="astro-basis-label">星象依据</text>
                  <text class="astro-basis-text">{{card.astroBasis}}</text>
                </view>
              </view>
            </block>
          </view>

          <!-- action_plan: 星象建议 -->
          <view wx:elif="{{item.type === 'action_plan'}}" class="report-section fade-in">
            <text class="report-section-title font-ancient">{{item.title}}</text>
            <view wx:if="{{item.tips && item.tips.length > 0}}" class="tips-card ink-border">
              <block wx:for="{{item.tips}}" wx:for-item="tip" wx:for-index="tipIdx" wx:key="*this">
                <view class="tip-item">
                  <text class="tip-bullet">{{tipIdx + 1}}</text>
                  <text class="tip-text">{{tip}}</text>
                </view>
              </block>
            </view>
          </view>

          <!-- closing: 温暖寄语 -->
          <view wx:elif="{{item.type === 'closing'}}" class="report-section fade-in">
            <view class="report-closing ink-border">
              <text class="closing-text">{{item.content}}</text>
            </view>
          </view>

        </block>
      </block>

      <view class="scroll-bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- ===== 底部栏 ===== -->
  <view class="bottom-bar">
    <view class="bottom-bar-inner">
      <block wx:if="{{viewMode === 'dashboard'}}">
        <button class="action-btn primary-btn" bindtap="startRecord">
          <text>记录心情</text>
        </button>
      </block>

      <block wx:elif="{{viewMode === 'record'}}">
        <button class="action-btn secondary-btn" bindtap="exitRecord">算了</button>
        <button class="action-btn primary-btn flex-grow" bindtap="submitRecord">记录完成</button>
      </block>

      <block wx:elif="{{viewMode === 'result'}}">
        <block wx:if="{{!analyzing}}">
          <button class="action-btn primary-btn" bindtap="completeAndReturn">好的</button>
        </block>
      </block>
    </view>
  </view>
</view>
