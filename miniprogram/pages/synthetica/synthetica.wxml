<view class="container">
  <view class="banner">
    <text class="banner-label">提示</text>
    <text class="banner-text">自由组合星象，AI 深度洞察心理机制与未来时机</text>
  </view>

  <view class="card form-card">
    <!-- 01. Context -->
    <view class="section">
      <view class="section-header">
        <view class="tag tag-rose">01</view>
        <text class="section-title">咨询目标</text>
      </view>
      <picker range="{{CONTEXTS}}" range-key="label" value="{{contextIndex}}" bindchange="onContextChange">
        <view class="picker-box">
          <text class="picker-text">{{params.context.label}}</text>
          <text class="picker-arrow">选择</text>
        </view>
      </picker>
    </view>

    <view class="divider"></view>

    <!-- 02. Foundation -->
    <view class="section">
      <view class="section-header">
        <view class="tag tag-blue">02</view>
        <text class="section-title">本命配置</text>
      </view>
      
      <view class="input-group">
        <view class="input-row">
          <text class="input-label">行星</text>
          <picker range="{{PLANETS}}" range-key="name" value="{{planetIndex}}" bindchange="onPlanetChange" class="picker-flex">
            <view class="picker-box">
              <text class="picker-text">{{params.planet.name}}</text>
              <text class="picker-arrow">选择</text>
            </view>
          </picker>
        </view>

        <view class="input-row">
          <text class="input-label">星座</text>
          <picker range="{{SIGNS}}" range-key="name" value="{{signIndex}}" bindchange="onSignChange" class="picker-flex">
            <view class="picker-box">
              <text class="picker-text">{{params.sign.name}}</text>
              <text class="picker-arrow">选择</text>
            </view>
          </picker>
        </view>

        <view class="input-row">
          <text class="input-label">宫位</text>
          <picker range="{{HOUSES}}" range-key="name" value="{{houseIndex}}" bindchange="onHouseChange" class="picker-flex">
            <view class="picker-box">
              <text class="picker-text">{{params.house.name}}</text>
              <text class="picker-arrow">选择</text>
            </view>
          </picker>
        </view>
      </view>
    </view>

    <view class="divider"></view>

    <!-- 03. Aspects -->
    <view class="section">
      <view class="section-header space-between">
        <view class="header-left">
          <view class="tag tag-purple">03</view>
          <text class="section-title">相位关系</text>
        </view>
        <view class="add-btn" bindtap="addAspect">
          <text>+ 添加相位</text>
        </view>
      </view>

      <view class="aspect-list">
        <block wx:if="{{params.aspects.length === 0}}">
          <view class="empty-state">
            <text>未添加相位（可选）</text>
          </view>
        </block>
        <block wx:else>
          <view wx:for="{{params.aspects}}" wx:key="index" class="aspect-item">
            <view class="aspect-pickers">
              <picker range="{{ASPECT_TYPES}}" range-key="name" value="{{item.typeIndex}}" data-index="{{index}}" bindchange="onAspectTypeChange" class="picker-half">
                <view class="picker-box small">
                  <text class="picker-text">{{item.type.name}}</text>
                  <text class="picker-arrow">选择</text>
                </view>
              </picker>
              <picker range="{{PLANETS}}" range-key="name" value="{{item.targetIndex}}" data-index="{{index}}" bindchange="onAspectTargetChange" class="picker-half">
                <view class="picker-box small">
                  <text class="picker-text">{{item.target.name}}</text>
                  <text class="picker-arrow">选择</text>
                </view>
              </picker>
            </view>
            <view class="delete-btn" data-index="{{index}}" bindtap="removeAspect">
              <text>删除</text>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- Result -->
  <view wx:if="{{result}}" class="card result-card">
    <view class="result-header">
      <view class="icon-box">AI</view>
      <view>
        <view class="result-title">深度洞察报告</view>
        <view class="result-subtitle">SYNTHESIS REPORT</view>
      </view>
    </view>
    <view class="result-content">
      <text>{{result}}</text>
    </view>
    <view class="result-tags">
      <view class="result-tag tag-indigo">{{params.planet.name}} · {{params.sign.name}}</view>
      <view class="result-tag tag-blue">{{params.house.name}}</view>
      <block wx:for="{{params.aspects}}" wx:key="index">
        <view class="result-tag tag-rose">{{item.type.name}} {{item.target.name}}</view>
      </block>
    </view>
  </view>

  <view class="bottom-spacer"></view>
</view>

<!-- Fixed Bottom Button -->
<view class="bottom-bar">
  <button class="generate-btn {{loading ? 'disabled' : ''}}" bindtap="handleGenerate" disabled="{{loading}}">
    {{loading ? '正在解码星象...' : '生成深度洞察'}}
  </button>
</view>
