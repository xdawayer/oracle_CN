<view class="page-container">
  <!-- 步骤指示器 -->
  <view class="step-indicator">
    <text class="step-text">步骤 {{step}}/2</text>
  </view>

  <!-- 步骤一：出生日期与时间 -->
  <view class="step-content" wx:if="{{step === 1}}">
    <view class="step-header">
      <text class="step-title font-ancient">{{isEditMode ? '修改出生资料' : '填写出生日期与时间'}}</text>
      <text class="step-desc">准确的出生时间有助于更精确的个性化分析</text>
    </view>

    <!-- 日历类型选择 -->
    <view class="form-group">
      <text class="form-label">日历类型</text>
      <picker mode="selector" range="{{calendarTypes}}" range-key="label" value="{{calendarTypeIndex}}" bindchange="onCalendarTypeChange">
        <view class="picker-display">
          <text class="picker-value">{{calendarTypes[calendarTypeIndex].label}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <!-- 出生日期 -->
    <view class="form-group">
      <text class="form-label">出生日期</text>
      <picker mode="date" value="{{birthDate}}" start="1900-01-01" end="{{maxDate}}" bindchange="onDateChange">
        <view class="picker-display">
          <text class="picker-value {{!birthDate ? 'placeholder' : ''}}">{{birthDate || '请选择日期'}}</text>
        </view>
      </picker>
      <text class="form-hint" wx:if="{{calendarTypeIndex === 1}}">选择农历日期后将自动转换为公历</text>
    </view>

    <!-- 出生时间 -->
    <view class="form-group">
      <text class="form-label">出生时间</text>
      <picker mode="time" value="{{birthTime}}" bindchange="onTimeChange" disabled="{{timeUncertain}}">
        <view class="picker-display {{timeUncertain ? 'disabled' : ''}}">
          <text class="picker-value {{!birthTime ? 'placeholder' : ''}}">{{birthTime || '请选择时间'}}</text>
        </view>
      </picker>
    </view>

    <!-- 不确定时间勾选 -->
    <view class="checkbox-group" bindtap="toggleTimeUncertain">
      <view class="checkbox {{timeUncertain ? 'checked' : ''}}">
        <text class="checkbox-mark" wx:if="{{timeUncertain}}">✓</text>
      </view>
      <text class="checkbox-label">不确定具体时间（默认12:00）</text>
    </view>
  </view>

  <!-- 步骤二：出生地点 -->
  <view class="step-content" wx:if="{{step === 2}}">
    <view class="step-header">
      <text class="step-title font-ancient">填写出生地点</text>
      <text class="step-desc">出生地用于计算当地时区与经纬度</text>
    </view>

    <!-- 城市搜索 -->
    <view class="form-group">
      <text class="form-label">出生城市</text>
      <view class="city-search-wrap">
        <input
          class="city-input"
          placeholder="{{cityPlaceholder}}"
          placeholder-class="input-placeholder"
          value="{{cityInput}}"
          bindinput="onCityInput"
          bindfocus="onCityInputFocus"
          bindblur="onCityInputBlur"
        />
        <!-- 城市候选列表 -->
        <view class="city-dropdown" wx:if="{{showCityDropdown && cityResults.length > 0}}">
          <view
            class="city-item"
            wx:for="{{cityResults}}"
            wx:key="id"
            bindtap="onSelectCity"
            data-city="{{item}}"
          >
            <text class="city-name">{{item.displayText}}</text>
          </view>
        </view>
        <!-- 无匹配提示 -->
        <view class="city-dropdown" wx:if="{{showCityDropdown && cityInput && cityResults.length === 0}}">
          <view class="city-item no-result">
            <text class="city-name">未找到匹配城市</text>
          </view>
        </view>
      </view>
      <text class="form-hint" wx:if="{{selectedCity}}">经度: {{selectedCity.lon}}° 纬度: {{selectedCity.lat}}°</text>
    </view>
  </view>

  <!-- 底部按钮区 -->
  <view class="bottom-area">
    <!-- 信任标识 -->
    <view class="trust-badge">
      <text class="trust-text">基于心理学与天文学模型</text>
      <text class="trust-text">提供科学的个性化分析</text>
    </view>

    <!-- 协议勾选 -->
    <view class="agreement-check" bindtap="toggleAgreed">
      <view class="checkbox {{agreedTerms ? 'checked' : ''}}">
        <text class="checkbox-mark" wx:if="{{agreedTerms}}">✓</text>
      </view>
      <view class="agreement-check-text">
        <text class="agreement-hint-text">我已阅读并同意</text>
        <text class="agreement-link" catchtap="goToTerms">《用户协议》</text>
        <text class="agreement-hint-text">和</text>
        <text class="agreement-link" catchtap="goToPrivacy">《隐私政策》</text>
      </view>
    </view>

    <!-- 按钮 -->
    <view class="btn-group">
      <view class="btn-back" wx:if="{{step === 2}}" bindtap="goBack">
        <text>上一步</text>
      </view>
      <view class="btn-primary {{!(canProceed && agreedTerms) ? 'disabled' : ''}}" bindtap="goNext">
        <text>{{step === 2 ? (isEditMode ? '保存' : '完成') : '下一步'}}</text>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>
</view>
