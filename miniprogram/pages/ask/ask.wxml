<view class="page-container">
  <!-- 问题输入界面（报告不显示时可见） -->
  <view wx:if="{{!showReport}}">
    <!-- Header -->
    <view class="header ink-border">
      <view class="header-content">
        <view class="title-section">
          <view class="title-row">
            <text class="app-title font-ancient">AI 问答</text>
            <view class="quota-badge" wx:if="{{quotaLoaded}}">
              <text class="quota-text" wx:if="{{askTotalLeft > 0}}">本周剩余 {{askTotalLeft}} 次</text>
              <text class="quota-text quota-empty" wx:else>本周次数已用完 · {{askCost}}积分/次</text>
            </view>
          </view>
          <text class="app-subtitle">INSIGHT REPORT</text>
        </view>

        <!-- Goal Selector -->
        <picker bindchange="onGoalChange" value="{{currentGoalIndex}}" range="{{goals}}" range-key="label">
          <view class="goal-picker">
            <view class="picker-trigger ink-border">
              <text>咨询主题: {{currentGoalLabel}}</text>
              <view class="arrow-down"></view>
            </view>
          </view>
        </picker>
      </view>
    </view>

    <!-- 推荐问题列表 -->
    <scroll-view class="question-scroll" scroll-y show-scrollbar="false">
      <view class="suggestions-container">
        <view class="suggestions-header">
          <text class="suggestions-title font-ancient">推荐问题</text>
          <text class="suggestions-hint">点击选择，可编辑后发送</text>
        </view>
        <view class="suggestions-grid">
          <block wx:for="{{currentSuggestions}}" wx:key="index">
            <view class="suggestion-item ink-border" bindtap="onSuggestionClick" data-text="{{item}}">
              <text class="suggestion-text">{{item}}</text>
            </view>
          </block>
        </view>
      </view>
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- Input Area -->
    <view class="input-area">
      <view class="input-wrapper">
        <input
          class="chat-input"
          value="{{inputValue}}"
          focus="{{inputFocus}}"
          bindinput="onInput"
          bindconfirm="onSend"
          confirm-type="send"
          placeholder="描述你的问题或困惑..."
          placeholder-class="input-placeholder"
          disabled="{{isLoading}}"
        />
        <view
          class="send-btn {{inputValue ? 'send-btn-active' : ''}}"
          bindtap="onSend"
        >
          <text class="send-icon">发送</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 全屏报告覆盖层 -->
  <view class="report-overlay" wx:if="{{showReport}}">
    <!-- Loading 状态 -->
    <view class="report-loading" wx:if="{{reportLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在深度分析中...</text>
      <text class="loading-hint">结合你的个人特质综合解读</text>
    </view>

    <!-- 报告内容 -->
    <scroll-view scroll-y class="report-scroll" wx:if="{{reportData && !reportLoading}}" show-scrollbar="false">

      <!-- 分析概况（Canvas 在 scroll-view 中有层级问题，使用文字展示） -->
      <view class="report-chart-summary ink-border" wx:if="{{reportData.astroContext}}">
        <text class="chart-label font-ancient">分析概况</text>
        <view class="chart-info-list" wx:if="{{reportData.astroContext.keyPlanets && reportData.astroContext.keyPlanets.length > 0}}">
          <text class="chart-info-title">关键要素</text>
          <text class="chart-info-item" wx:for="{{reportData.astroContext.keyPlanets}}" wx:key="*this">{{item}}</text>
        </view>
        <view class="chart-info-list" wx:if="{{reportData.astroContext.keyAspects && reportData.astroContext.keyAspects.length > 0}}">
          <text class="chart-info-title">关键关联</text>
          <text class="chart-info-item" wx:for="{{reportData.astroContext.keyAspects}}" wx:key="*this">{{item}}</text>
        </view>
        <view class="chart-info-list" wx:if="{{reportData.astroContext.currentTransits && reportData.astroContext.currentTransits.length > 0}}">
          <text class="chart-info-title">当前周期</text>
          <text class="chart-info-item" wx:for="{{reportData.astroContext.currentTransits}}" wx:key="*this">{{item}}</text>
        </view>
      </view>

      <!-- 问题回顾 -->
      <view class="report-question-card ink-border">
        <text class="question-label">你的问题</text>
        <text class="question-text">{{reportQuestion}}</text>
        <text class="question-category">{{reportCategory}}</text>
      </view>

      <!-- 深度解读层 -->
      <block wx:for="{{reportData.sections}}" wx:key="index">
        <!-- astro_insight 类型 -->
        <view wx:if="{{item.type === 'astro_insight'}}" class="report-section">
          <view class="section-header">
            <text class="section-title font-ancient">{{item.title}}</text>
          </view>
          <view class="report-card ink-border" wx:for="{{item.cards}}" wx:for-item="card" wx:key="title">
            <text class="card-title">{{card.title}}</text>
            <text class="card-content">{{card.content}}</text>
            <view class="card-astro-basis" wx:if="{{card.astroBasis}}">
              <text class="astro-label">分析依据</text>
              <text class="astro-text">{{card.astroBasis}}</text>
            </view>
          </view>
        </view>

        <!-- deep_analysis 类型 -->
        <view wx:elif="{{item.type === 'deep_analysis'}}" class="report-section">
          <view class="section-header">
            <text class="section-title font-ancient">{{item.title}}</text>
          </view>
          <view class="report-card ink-border" wx:for="{{item.cards}}" wx:for-item="card" wx:key="title">
            <text class="card-title">{{card.title}}</text>
            <text class="card-content">{{card.content}}</text>
            <view class="card-astro-basis" wx:if="{{card.astroBasis}}">
              <text class="astro-label">分析依据</text>
              <text class="astro-text">{{card.astroBasis}}</text>
            </view>
          </view>
        </view>

        <!-- action_plan 类型 -->
        <view wx:elif="{{item.type === 'action_plan'}}" class="report-section">
          <view class="section-header">
            <text class="section-title font-ancient">{{item.title}}</text>
          </view>
          <view class="report-card ink-border tips-card">
            <view class="tips-list">
              <view class="tip-item" wx:for="{{item.tips}}" wx:for-item="tip" wx:key="*this">
                <text class="tip-bullet">{{index + 1}}</text>
                <text class="tip-text">{{tip}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- closing 类型 -->
        <view wx:elif="{{item.type === 'closing'}}" class="report-section">
          <view class="report-closing ink-border">
            <text class="closing-text">{{item.content}}</text>
          </view>
        </view>
      </block>

      <!-- 底部操作 -->
      <view class="report-bottom-action">
        <view class="report-action-btn ink-border" bindtap="closeReport">
          <text class="action-btn-text">继续提问</text>
        </view>
      </view>
      <view style="height: 80rpx;"></view>
    </scroll-view>
  </view>
</view>
