<view class="page">
  <view class="header">
    <text class="title font-ancient">运势</text>
    <text class="subtitle font-body">星辰指引与每日运势洞察</text>
  </view>

  <view class="date-nav">
    <view class="date-list">
      <view
        wx:for="{{dates}}"
        wx:key="day"
        class="date-item {{selectedDateIndex === index ? 'active' : ''}}"
        bindtap="onDateSelect"
        data-index="{{index}}"
      >
        <text class="date-weekday">{{item.weekday}}</text>
        <text class="date-month" wx:if="{{item.monthPrefix}}">{{item.monthPrefix}}</text>
        <text class="date-day">{{item.day}}</text>
        <view wx:if="{{item.isToday && selectedDateIndex !== index}}" class="today-dot"></view>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.SUCCESS && forecast}}">
    
    <view class="overview-card ink-border">
      <view class="overview-header">
        <view class="overview-date">
          <text class="date-label font-body">今日运势</text>
          <text class="date-value font-ancient">{{currentDateStr}}</text>
        </view>
        
        <view class="score-display">
          <text class="score-number font-data">{{forecast.overall_score || 0}}</text>
          <text class="score-suffix font-body">分</text>
        </view>
      </view>
      
      <view class="overview-summary">
        <text class="summary-text">{{overviewSummary || '今日星象平和，适合稳步推进计划。'}}</text>
      </view>
      
      <view class="lucky-row">
        <view class="lucky-chip">
          <text class="lucky-label">幸运色</text>
          <text class="lucky-value">{{forecast.lucky_color || '深蓝'}}</text>
        </view>
        <view class="lucky-divider"></view>
        <view class="lucky-chip">
          <text class="lucky-label">幸运数</text>
          <text class="lucky-value">{{forecast.lucky_number || '7'}}</text>
        </view>
        <view class="lucky-divider"></view>
        <view class="lucky-chip">
          <text class="lucky-label">吉位</text>
          <text class="lucky-value">{{forecast.lucky_direction || '北方'}}</text>
        </view>
      </view>
    </view>

    <view class="dimensions-section">
      <text class="section-title font-ancient">四维运势</text>

      <view class="dimension-list">
        <view class="dimension-item" wx:for="{{dimensionItems}}" wx:key="key" bindtap="onViewDetail" data-type="{{item.key}}">
          <view class="dimension-header">
            <text class="dimension-name font-body">{{item.label}}</text>
          </view>
          <view class="dimension-bar-container">
            <view class="dimension-bar dimension-bar--{{item.key}}" style="width: {{item.score || 0}}%"></view>
          </view>
          <text class="dimension-score font-data">{{item.score || '-'}}</text>
        </view>
      </view>
    </view>

    <view class="advice-section">
      <view class="advice-card advice-do ink-border">
        <view class="advice-header">
          <view class="advice-badge do-badge">宜</view>
          <text class="advice-title-text">{{advice.do.title || (forecast.strategy && forecast.strategy.best_use) || '积极行动'}}</text>
        </view>
        <view class="advice-list" wx:if="{{advice.do.details && advice.do.details.length > 0}}">
          <view class="advice-item" wx:for="{{advice.do.details}}" wx:key="*this">
            <text class="advice-text">{{item}}</text>
          </view>
        </view>
      </view>
      
      <view class="advice-card advice-dont ink-border">
        <view class="advice-header">
          <view class="advice-badge dont-badge">忌</view>
          <text class="advice-title-text">{{advice.dont.title || (forecast.strategy && forecast.strategy.avoid) || '盲目冒险'}}</text>
        </view>
        <view class="advice-list" wx:if="{{advice.dont.details && advice.dont.details.length > 0}}">
          <view class="advice-item" wx:for="{{advice.dont.details}}" wx:key="*this">
            <text class="advice-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 4. 时间窗口 -->
    <view class="time-section card">
      <text class="card-title">时间窗口</text>
      
      <view class="time-timeline">
        <view class="time-slot" wx:for="{{timeWindows}}" wx:key="period">
          <view class="time-line">
            <view class="time-dot" style="background: {{item.dotColor}}"></view>
            <view class="time-connector" wx:if="{{index < timeWindows.length - 1}}"></view>
          </view>
          <view class="time-content">
            <view class="time-header">
              <text class="time-period">{{item.period}}</text>
              <text class="time-range">{{item.time}}</text>
              <view class="energy-tag" style="background: {{item.tagBg}}; color: {{item.tagColor}}">
                <view class="energy-dot" style="background: {{item.dotColor}}"></view>
                <text class="energy-text">{{item.energyLevel}}</text>
              </view>
            </view>
            <text class="time-desc">{{item.description}}</text>
            <view class="time-tips" wx:if="{{item.bestForStr}}">
              <text class="tip-label">适合：</text>
              <text class="tip-value">{{item.bestForStr}}</text>
            </view>
            <view class="time-tips" wx:if="{{item.avoidForStr}}">
              <text class="tip-label">避免：</text>
              <text class="tip-value">{{item.avoidForStr}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ========== 深度解读层 ========== -->
    
    <!-- 5. 今日行运星象 -->
    <view class="card technical-card ink-border">
      <view class="card-header-row font-ancient">
        <text class="card-title">今日行运星象</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="chart">全屏阅读</view>
      </view>
        
        <view class="chart-content">
          <view class="chart-legend">
            <view class="legend-item"><view class="dot aspect-sextile"></view><text>六合</text></view>
            <view class="legend-item"><view class="dot aspect-square"></view><text>刑</text></view>
            <view class="legend-item"><view class="dot aspect-trine"></view><text>拱</text></view>
            <view class="legend-item"><view class="dot aspect-opposition"></view><text>冲</text></view>
          </view>
          
          <view class="chart-wrapper ink-chart" wx:if="{{transitChartData.innerPositions.length > 0 && !showReport && !selectedPlanet}}">
            <astro-chart
              type="transit"
              positions="{{transitChartData.innerPositions}}"
              outerPositions="{{transitChartData.outerPositions}}"
              aspects="{{transitChartData.aspects}}"
              houseCusps="{{transitChartData.houseCusps}}"
              width="350"
              height="350"
              useExternalDetail="{{true}}"
              bind:planetdetail="onPlanetDetail"
              bind:planetdetailclose="closePlanetDetail"
            ></astro-chart>
          </view>
          <text class="chart-desc">内环：本命盘 | 外环：今日行运</text>
        </view>
      </view>

    <!-- 6. 相位矩阵 -->
    <view class="card technical-card ink-border" wx:if="{{technical.aspectMatrix}}">
      <view class="card-header-row font-ancient">
        <text class="card-title">星象详情：相位矩阵</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="aspects">全屏阅读</view>
      </view>
      <view class="technical-body">
        <view class="aspect-matrix-container">
          <view class="aspect-matrix">
            <view wx:for="{{technical.aspectMatrix}}" wx:for-item="row" wx:for-index="i" wx:key="i" class="matrix-row">
              <view wx:for="{{row}}" wx:for-item="cell" wx:for-index="j" wx:key="j" class="matrix-cell {{cell.isHeader ? 'cell-header font-ancient' : ''}} {{cell.isEmpty ? 'cell-empty' : ''}}">
                <text wx:if="{{cell.isHeader}}" class="p-symbol">{{cell.symbol}}</text>
                <view wx:elif="{{cell.aspect}}" class="a-info">
                  <text class="a-symbol" style="color: {{cell.aspect.color}}">{{cell.aspect.symbol}}</text>
                  <text class="a-orb">{{cell.aspect.orbText}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 7. 行运行星 -->
    <view class="card technical-card ink-border" wx:if="{{technical.transitPlanets}}">
      <view class="card-header-row font-ancient">
        <text class="card-title">行运行星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="planets">全屏阅读</view>
      </view>
        
        <view class="technical-body">
          <view class="planet-info-table">
            <view class="pi-row pi-head font-ancient">
              <view class="pi-cell pi-planet">星体</view>
              <view class="pi-cell pi-sign">星座</view>
              <view class="pi-cell pi-house">宫位</view>
              <view class="pi-cell pi-retro">逆行</view>
            </view>
            <view class="pi-row" wx:for="{{technical.transitPlanets}}" wx:key="name">
              <view class="pi-cell pi-planet">
                <view class="pi-icon-circle">
                  <text class="glyph" style="color: {{item.meta.color}}">{{item.meta.glyph}}</text>
                </view>
                <text class="pi-name">{{item.zhName}}</text>
              </view>
              <view class="pi-cell pi-sign">
                <view class="pi-icon-circle mini">
                  <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
                </view>
                <view class="pi-sign-info">
                  <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
                  <text class="pi-degree">{{item.degreeText}}</text>
                </view>
              </view>
              <view class="pi-cell pi-house">{{item.house}}宫</view>
              <view class="pi-cell pi-retro">
                <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
                <text wx:else class="retro-none">-</text>
              </view>
            </view>
          </view>
        </view>
    </view>

    <!-- 8. 行运小行星 -->
    <view class="card technical-card ink-border" wx:if="{{technical.transitAsteroids}}">
      <view class="card-header-row font-ancient">
        <text class="card-title">行运小行星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="asteroids">全屏阅读</view>
      </view>
      <view class="technical-body">
        <view class="planet-info-table">
          <view class="pi-row pi-head font-ancient">
            <view class="pi-cell pi-planet">星体</view>
            <view class="pi-cell pi-sign">星座</view>
            <view class="pi-cell pi-house">宫位</view>
            <view class="pi-cell pi-retro">逆行</view>
          </view>
          <view class="pi-row" wx:for="{{technical.transitAsteroids}}" wx:key="name">
            <view class="pi-cell pi-planet">
              <view class="pi-icon-circle">
                <text class="glyph" style="color: {{item.meta.color}}">{{item.meta.glyph}}</text>
              </view>
              <text class="pi-name">{{item.zhName}}</text>
            </view>
            <view class="pi-cell pi-sign">
              <view class="pi-icon-circle mini">
                <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
              </view>
              <view class="pi-sign-info">
                <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
                <text class="pi-degree">{{item.degreeText}}</text>
              </view>
            </view>
            <view class="pi-cell pi-house">{{item.house}}宫</view>
            <view class="pi-cell pi-retro">
              <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
              <text wx:else class="retro-none">-</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 9. 宫主星 -->
    <view class="card technical-card ink-border" wx:if="{{technical.houseRulers}}">
      <view class="card-header-row font-ancient">
        <text class="card-title">宫主星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="rulers">全屏阅读</view>
      </view>
      <view class="technical-body">
        <view class="planet-info-table">
          <view class="pi-row pi-head font-ancient">
            <view class="pi-cell pi-hr-house">宫位</view>
            <view class="pi-cell pi-hr-sign">星座</view>
            <view class="pi-cell pi-hr-ruler">宫主星</view>
            <view class="pi-cell pi-hr-arrow"></view>
            <view class="pi-cell pi-hr-fly">飞入宫位</view>
          </view>
          <view class="pi-row" wx:for="{{technical.houseRulers}}" wx:key="house">
            <view class="pi-cell pi-hr-house">{{item.house}}</view>
            <view class="pi-cell pi-hr-sign">
              <view class="pi-icon-circle mini">
                <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
              </view>
              <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
            </view>
            <view class="pi-cell pi-hr-ruler">
              <view class="pi-icon-circle mini">
                <text class="glyph-small" style="color: {{item.rulerMeta.color}}">{{item.rulerMeta.glyph}}</text>
              </view>
              <text class="pi-name">{{item.zhRuler}}</text>
            </view>
            <view class="pi-cell pi-hr-arrow"></view>
            <view class="pi-cell pi-hr-fly">
              <view class="fly-capsule ink-border">
                <text class="fly-arrow">→</text>
                <image class="pi-icon mini-fly" src="{{item.fliesToSignIcon}}" mode="aspectFit"></image>
                <text class="fly-text" style="color: {{item.fliesToSignMeta.color}}">{{item.zhFliesToSign}}</text>
                <text class="fly-house">{{item.fliesTo}}宫</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ========== 趋势预览层 ========== -->

    <!-- 8. 本周运势趋势 -->
    <view class="weekly-section card ink-border">
      <text class="card-title weekly-title font-ancient">本周趋势 ({{weekRangeTitle}})</text>

      <!-- 柱状图 -->
      <view class="weekly-chart" wx:if="{{weeklyScores.length > 0}}">
        <view class="chart-bar-group" wx:for="{{weeklyScores}}" wx:key="date">
          <text class="bar-score-top">{{item.score}}</text>
          <view class="chart-bar-wrapper">
            <view class="chart-bar {{item.isToday ? 'today-bar' : ''}}" style="height: {{item.score || 5}}%;"></view>
          </view>
          <text class="chart-day {{item.isToday ? 'today' : ''}}">{{item.day}}</text>
        </view>
      </view>

      <!-- 一周7天解读 -->
      <view class="weekly-desc-list" wx:if="{{weeklyDescriptions.length > 0}}">
        <view class="weekly-desc-item {{item.isSpecial ? 'special' : ''}}" wx:for="{{weeklyDescriptions}}" wx:key="index">
          <text class="weekly-desc-date">{{item.dateLabel}}</text>
          <view class="weekly-desc-content">
            <text class="weekly-desc-title font-ancient">{{item.title}}</text>
            <text class="weekly-desc-detail">{{item.description}}</text>
          </view>
        </view>
      </view>

      <!-- 空状态提示 -->
      <view class="weekly-empty" wx:if="{{weeklyScores.length === 0 && weeklyDescriptions.length === 0}}">
        <text class="weekly-empty-text">本周趋势数据生成中，请稍后刷新</text>
      </view>
    </view>

    <!-- 月度运势深度解读入口 -->
    <view class="premium-banner monthly-banner {{monthlyColorClass}} {{monthlyReportStatus === 'processing' ? 'processing' : monthlyReportStatus === 'completed' ? 'completed' : ''}}" bindtap="onOpenMonthlyReport">
      <view class="premium-info">
        <text class="premium-title">{{monthlyEntryTitle}}</text>
        <text class="premium-desc">
          {{monthlyReportStatus === 'none' ? '解锁当月运势深度指南' :
            monthlyReportStatus === 'pending' ? '任务排队中，请稍候...' :
            monthlyReportStatus === 'processing' ? '正在为你生成专属报告...' :
            monthlyReportStatus === 'completed' ? '查看你的专属月度运势' :
            monthlyReportStatus === 'failed' ? '生成失败，点击重试' : '解锁当月运势深度指南'}}
        </text>
        <view wx:if="{{monthlyReportStatus === 'processing' || monthlyReportStatus === 'pending'}}" class="banner-progress">
          <view class="banner-progress-bar">
            <view class="banner-progress-fill" style="width: {{monthlyReportProgress || 0}}%"></view>
          </view>
          <text class="banner-progress-text">{{monthlyReportProgress || 0}}%</text>
        </view>
      </view>
      <view class="premium-btn {{monthlyReportStatus === 'processing' || monthlyReportStatus === 'pending' ? 'btn-processing' : ''}}">
        {{monthlyReportStatus === 'none' ? '立即解锁' :
          monthlyReportStatus === 'pending' ? '排队中' :
          monthlyReportStatus === 'processing' ? '生成中' :
          monthlyReportStatus === 'completed' ? '查看报告' :
          monthlyReportStatus === 'failed' ? '重试' : '立即解锁'}}
      </view>
    </view>

  </view>

  <!-- 行星详情卡片 -->
  <view class="planet-detail-mask" wx:if="{{selectedPlanet}}" bindtap="closePlanetDetail"></view>
  <view class="planet-detail-card" wx:if="{{selectedPlanet}}" catchtap="stopProp">
    <view class="card-close" bindtap="closePlanetDetail">×</view>
    <view class="card-header">
      <view class="planet-glyph" style="color: {{selectedPlanet.color}};">{{selectedPlanet.glyph}}</view>
      <view class="planet-info">
        <view class="planet-name-row">
          <view class="planet-name" style="color: {{selectedPlanet.color}};">{{selectedPlanet.displayName}}</view>
          <view class="planet-badge">{{selectedPlanet.isRetrograde ? '逆行' : '顺行'}}</view>
        </view>
        <view class="planet-keywords" wx:if="{{selectedPlanet.keywords}}">{{selectedPlanet.keywords}}</view>
      </view>
    </view>

    <view class="card-section">
      <view class="section-label">星座位置</view>
      <view class="section-row">
        <view class="section-text">位于</view>
        <view class="sign-name" style="color: {{selectedPlanet.signColor}};">{{selectedPlanet.signName}}</view>
        <image class="sign-icon" src="{{selectedPlanet.signIcon}}" mode="aspectFit"></image>
        <view class="section-text">{{selectedPlanet.degree}}°{{selectedPlanet.minute}}'</view>
      </view>
    </view>

    <view class="card-section" wx:if="{{selectedPlanet.house}}">
      <view class="section-label">宫位信息</view>
      <view class="section-row">
        <view class="section-text">位于</view>
        <view class="house-num">{{selectedPlanet.house}}</view>
        <view class="section-text">宫</view>
        <block wx:if="{{selectedPlanet.ruledHouses}}">
          <view class="divider">|</view>
          <view class="section-text">守护</view>
          <view class="house-num">{{selectedPlanet.ruledHouses}}</view>
          <view class="section-text">宫</view>
        </block>
      </view>
    </view>

    <view class="card-section" wx:if="{{selectedPlanet.aspects && selectedPlanet.aspects.length > 0}}">
      <view class="section-label">主要相位</view>
      <view class="aspect-list">
        <view class="aspect-row" wx:for="{{selectedPlanet.aspects}}" wx:key="index">
          <view class="section-text">与</view>
          <view class="other-planet" style="color: {{item.otherColor}};">{{item.otherName}}</view>
          <view class="other-glyph" style="color: {{item.otherColor}};">{{item.otherGlyph}}</view>
          <view class="section-text">成</view>
          <view class="aspect-angle" style="color: {{item.aspectColor}};">{{item.angle}}°</view>
          <view class="aspect-symbol" style="color: {{item.aspectColor}};">{{item.aspectSymbol}}</view>
          <view class="aspect-orb">{{item.orb}}°</view>
          <view class="cross-badge" wx:if="{{item.isCross}}">跨盘</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 全屏解读报告 -->
  <view class="daily-report-overlay" wx:if="{{showReport && reportData}}">
    <view class="daily-report-topbar">
      <view class="daily-report-back" bindtap="closeReport">
        <view class="daily-report-back-icon"></view>
      </view>
      <text class="daily-report-top-title font-ancient">{{reportData.title}}</text>
      <view class="daily-report-top-placeholder"></view>
    </view>
    <scroll-view scroll-y class="daily-report-scroll" show-scrollbar="false">
      <view class="daily-report-header" wx:if="{{reportData.subtitle}}">
        <text class="daily-report-subtitle">{{reportData.subtitle}}</text>
      </view>

      <view class="detail-card detail-card--{{item.cardColor || 'default'}}"
            wx:for="{{reportData.sections}}" wx:key="title">
        <view class="detail-card__accent"></view>
        <view class="detail-card__body">
          <text class="detail-card__title">{{item.title}}</text>
          <text class="detail-card__text" wx:if="{{item.text}}">{{item.text}}</text>
          <view class="detail-card__list" wx:if="{{item.list && item.list.length > 0}}">
            <view class="detail-card__list-item" wx:for="{{item.list}}" wx:for-item="listItem" wx:for-index="idx" wx:key="idx">
              <text class="detail-card__list-num">{{idx + 1}}.</text>
              <text class="detail-card__list-text">{{listItem}}</text>
            </view>
          </view>
        </view>
      </view>

    </scroll-view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.LOADING}}">
    <view class="card">
      <text class="loading-text">正在生成今日运势...</text>
    </view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.ERROR}}">
    <view class="card">
      <text class="error-text">无法获取今日运势，请先完善出生信息。</text>
    </view>
  </view>

  <!-- 支付弹窗 -->
  <view class="payment-mask" wx:if="{{showPayment}}" bindtap="closePayment" catchtouchmove="true"></view>
  <view class="payment-sheet {{showPayment ? 'show' : ''}}" wx:if="{{showPayment}}">
    <view class="payment-body">
      <view class="payment-handle"></view>

      <view class="payment-header">
        <text class="payment-title font-ancient">{{paymentMeta.title}}</text>
        <text class="payment-subtitle">{{paymentMeta.subtitle}}</text>
      </view>

      <view class="payment-features">
        <block wx:for="{{paymentMeta.features}}" wx:key="title">
          <view class="payment-feature-item">
            <view class="feature-icon">◈</view>
            <view class="feature-content">
              <text class="feature-title">{{item.title}}</text>
              <text class="feature-desc">{{item.desc}}</text>
            </view>
          </view>
        </block>
      </view>

      <view class="payment-price-section">
        <view class="payment-price-row">
          <text class="payment-price-label">报告价格</text>
          <view class="payment-price-value">
            <text class="payment-price-num">{{paymentMeta.price}}</text>
            <text class="payment-price-unit">积分</text>
          </view>
        </view>
        <text class="payment-price-note">{{paymentMeta.note}}</text>
      </view>
    </view>

    <view class="payment-actions">
      <button class="payment-btn-primary" bindtap="handlePay" loading="{{paymentLoading}}">
        {{paymentLoading ? '生成中...' : '立即解锁'}}
      </button>
      <view class="payment-btn-cancel" bindtap="closePayment">稍后再说</view>
    </view>
  </view>
</view>
