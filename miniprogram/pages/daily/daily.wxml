<view class="page">
  <view class="header">
    <text class="title">运势</text>
    <text class="subtitle">星辰指引与每日能量解析</text>
  </view>

  <view class="date-nav">
    <view class="date-list">
      <view
        wx:for="{{dates}}"
        wx:key="day"
        class="date-item {{selectedDateIndex === index ? 'active' : ''}}"
        bindtap="onDateSelect"
        data-index="{{index}}"
      >
        <text class="date-weekday">{{item.weekday}}</text>
        <text class="date-day">{{item.day}}</text>
        <view wx:if="{{item.isToday && selectedDateIndex !== index}}" class="today-dot"></view>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.SUCCESS && forecast}}">
    
    <!-- ========== 快速浏览层 ========== -->
    
    <!-- 1. 今日运势概览卡片 -->
    <view class="overview-card">
      <view class="overview-header">
        <view class="overview-date">
          <text class="date-label">今日运势</text>
          <text class="date-value">{{currentDateStr}}</text>
        </view>
        
        <!-- Ring Progress Score -->
        <view class="score-ring-container">
          <view class="score-ring" style="background: conic-gradient(var(--accent) {{forecast.overall_score * 3.6}}deg, var(--paper-200) 0deg);">
            <view class="score-ring-inner">
              <text class="score-number">{{forecast.overall_score || 0}}</text>
              <text class="score-suffix">分</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="overview-summary">
        <text class="summary-text">{{overviewSummary || '今日星象平和，适合稳步推进计划。'}}</text>
      </view>
      
      <view class="lucky-row">
        <view class="lucky-chip">
          <text class="lucky-label">幸运色</text>
          <view class="lucky-color-dot" style="background: {{luckyColorToken || 'var(--accent)'}}"></view>
          <text class="lucky-value">{{forecast.lucky_color || '深蓝'}}</text>
        </view>
        <view class="lucky-divider"></view>
        <view class="lucky-chip">
          <text class="lucky-label">幸运数</text>
          <text class="lucky-value lucky-number">{{forecast.lucky_number || '7'}}</text>
        </view>
        <view class="lucky-divider"></view>
        <view class="lucky-chip">
          <text class="lucky-label">吉位</text>
          <text class="lucky-value">{{forecast.lucky_direction || '北方'}}</text>
        </view>
      </view>
    </view>

    <!-- 2. 四维度评分 -->
    <view class="dimensions-section">
      <text class="section-title">四维运势</text>
      
      <view class="dimension-list">
      <view class="dimension-item" wx:for="{{dimensionItems}}" wx:key="key" bindtap="onViewDetail" data-type="{{item.key}}">
          <view class="dimension-header">
            <view class="dimension-icon" style="background: var(--paper-200); color: {{item.color}}">
              <view class="dimension-icon-inner icon-{{item.key}}"></view>
            </view>
            <text class="dimension-name">{{item.label}}</text>
            <text class="dimension-score" style="color: {{item.color}}">{{item.score || '-'}}</text>
          </view>
          <view class="dimension-score-ring" style="background: conic-gradient({{item.color}} {{(item.score || 0) * 3.6}}deg, var(--paper-200) 0deg);">
            <view class="dimension-score-inner">
              <text class="dimension-score-text">{{item.score || '-'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 3. 今日宜忌 -->
    <view class="advice-section">
      <view class="advice-card advice-do">
        <view class="advice-header">
          <view class="advice-badge do-badge">宜</view>
          <text class="advice-title-text">{{advice.do.title || forecast.strategy.best_use || '积极行动'}}</text>
        </view>
        <view class="advice-list" wx:if="{{advice.do.details && advice.do.details.length > 0}}">
          <view class="advice-item" wx:for="{{advice.do.details}}" wx:key="*this">
            <text class="advice-dot do-dot">·</text>
            <text class="advice-text">{{item}}</text>
          </view>
        </view>
      </view>
      
      <view class="advice-card advice-dont">
        <view class="advice-header">
          <view class="advice-badge dont-badge">忌</view>
          <text class="advice-title-text">{{advice.dont.title || forecast.strategy.avoid || '盲目冒险'}}</text>
        </view>
        <view class="advice-list" wx:if="{{advice.dont.details && advice.dont.details.length > 0}}">
          <view class="advice-item" wx:for="{{advice.dont.details}}" wx:key="*this">
            <text class="advice-dot dont-dot">·</text>
            <text class="advice-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 4. 时间窗口 -->
    <view class="time-section card">
      <text class="card-title">时间窗口</text>
      
      <view class="time-timeline">
        <view class="time-slot" wx:for="{{timeWindows}}" wx:key="period">
          <view class="time-line">
            <view class="time-dot" style="background: {{item.dotColor}}"></view>
            <view class="time-connector" wx:if="{{index < timeWindows.length - 1}}"></view>
          </view>
          <view class="time-content">
            <view class="time-header">
              <text class="time-period">{{item.period}}</text>
              <text class="time-range">{{item.time}}</text>
              <view class="energy-tag" style="background: {{item.tagBg}}; color: {{item.tagColor}}">
                <view class="energy-dot" style="background: {{item.dotColor}}"></view>
                <text class="energy-text">{{item.energyLevel}}</text>
              </view>
            </view>
            <text class="time-desc">{{item.description}}</text>
            <view class="time-tips" wx:if="{{item.bestForStr}}">
              <text class="tip-label">适合：</text>
              <text class="tip-value">{{item.bestForStr}}</text>
            </view>
            <view class="time-tips" wx:if="{{item.avoidForStr}}">
              <text class="tip-label">避免：</text>
              <text class="tip-value">{{item.avoidForStr}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ========== 深度解读层 ========== -->
    
    <!-- 5. 今日行运星象 -->
    <view class="card technical-card">
      <view class="card-header-row">
        <text class="card-title">今日行运星象</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="chart">查看详情</view>
      </view>
        
        <view class="chart-content">
          <view class="chart-legend">
            <view class="legend-item"><view class="dot aspect-sextile"></view><text>六合</text></view>
            <view class="legend-item"><view class="dot aspect-square"></view><text>刑</text></view>
            <view class="legend-item"><view class="dot aspect-trine"></view><text>拱</text></view>
            <view class="legend-item"><view class="dot aspect-opposition"></view><text>冲</text></view>
          </view>
          
          <view class="chart-wrapper" wx:if="{{transitChartData.innerPositions.length > 0}}">
            <astro-chart
              type="transit"
              positions="{{transitChartData.innerPositions}}"
              outerPositions="{{transitChartData.outerPositions}}"
              aspects="{{transitChartData.aspects}}"
              houseCusps="{{transitChartData.houseCusps}}"
              width="350"
              height="350"
              useExternalDetail="{{true}}"
              bind:planetdetail="onPlanetDetail"
              bind:planetdetailclose="closePlanetDetail"
            ></astro-chart>
          </view>
          <text class="chart-desc">内环：本命盘 | 外环：今日行运</text>
        </view>
      </view>

    <!-- 6. 相位矩阵 -->
    <view class="card technical-card" wx:if="{{technical.aspectMatrix}}">
      <view class="card-header-row">
        <text class="card-title">星象详情：相位矩阵</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="aspects">查看详情</view>
      </view>
      <view class="technical-body">
        <view class="aspect-matrix-container">
          <view class="aspect-matrix">
            <view wx:for="{{technical.aspectMatrix}}" wx:for-item="row" wx:for-index="i" wx:key="i" class="matrix-row">
              <view wx:for="{{row}}" wx:for-item="cell" wx:for-index="j" wx:key="j" class="matrix-cell {{cell.isHeader ? 'cell-header' : ''}} {{cell.isEmpty ? 'cell-empty' : ''}}">
                <text wx:if="{{cell.isHeader}}" class="p-symbol">{{cell.symbol}}</text>
                <view wx:elif="{{cell.aspect}}" class="a-info">
                  <text class="a-symbol" style="color: {{cell.aspect.color}}">{{cell.aspect.symbol}}</text>
                  <text class="a-orb">{{cell.aspect.orbText}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 7. 行运行星 -->
    <view class="card technical-card" wx:if="{{technical.transitPlanets}}">
      <view class="card-header-row">
        <text class="card-title">行运行星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="planets">查看详情</view>
      </view>
        
        <view class="technical-body">
          <view class="planet-info-table">
            <view class="pi-row pi-head">
              <view class="pi-cell pi-planet">星体</view>
              <view class="pi-cell pi-sign">星座</view>
              <view class="pi-cell pi-house">宫位</view>
              <view class="pi-cell pi-retro">逆行</view>
            </view>
            <view class="pi-row" wx:for="{{technical.transitPlanets}}" wx:key="name">
              <view class="pi-cell pi-planet">
                <view class="pi-icon-circle">
                  <text class="glyph" style="color: {{item.meta.color}}">{{item.meta.glyph}}</text>
                </view>
                <text class="pi-name">{{item.zhName}}</text>
              </view>
              <view class="pi-cell pi-sign">
                <view class="pi-icon-circle mini">
                  <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
                </view>
                <view class="pi-sign-info">
                  <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
                  <text class="pi-degree">{{item.degreeText}}</text>
                </view>
              </view>
              <view class="pi-cell pi-house">{{item.house}}宫</view>
              <view class="pi-cell pi-retro">
                <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
                <text wx:else class="retro-none">-</text>
              </view>
            </view>
          </view>
        </view>
    </view>

    <!-- 8. 行运小行星 -->
    <view class="card technical-card" wx:if="{{technical.transitAsteroids}}">
      <view class="card-header-row">
        <text class="card-title">行运小行星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="asteroids">查看详情</view>
      </view>
      <view class="technical-body">
        <view class="planet-info-table">
          <view class="pi-row pi-head">
            <view class="pi-cell pi-planet">星体</view>
            <view class="pi-cell pi-sign">星座</view>
            <view class="pi-cell pi-house">宫位</view>
            <view class="pi-cell pi-retro">逆行</view>
          </view>
          <view class="pi-row" wx:for="{{technical.transitAsteroids}}" wx:key="name">
            <view class="pi-cell pi-planet">
              <view class="pi-icon-circle">
                <text class="glyph" style="color: {{item.meta.color}}">{{item.meta.glyph}}</text>
              </view>
              <text class="pi-name">{{item.zhName}}</text>
            </view>
            <view class="pi-cell pi-sign">
              <view class="pi-icon-circle mini">
                <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
              </view>
              <view class="pi-sign-info">
                <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
                <text class="pi-degree">{{item.degreeText}}</text>
              </view>
            </view>
            <view class="pi-cell pi-house">{{item.house}}宫</view>
            <view class="pi-cell pi-retro">
              <text wx:if="{{item.isRetrograde}}" class="retro-tag">R</text>
              <text wx:else class="retro-none">-</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 9. 宫主星 -->
    <view class="card technical-card" wx:if="{{technical.houseRulers}}">
      <view class="card-header-row">
        <text class="card-title">宫主星</text>
        <view class="view-detail-btn" bindtap="onViewDetail" data-type="rulers">查看详情</view>
      </view>
      <view class="technical-body">
        <view class="planet-info-table">
          <view class="pi-row pi-head">
            <view class="pi-cell pi-hr-house">宫位</view>
            <view class="pi-cell pi-hr-sign">星座</view>
            <view class="pi-cell pi-hr-ruler">宫主星</view>
            <view class="pi-cell pi-hr-arrow"></view>
            <view class="pi-cell pi-hr-fly">飞入宫位</view>
          </view>
          <view class="pi-row" wx:for="{{technical.houseRulers}}" wx:key="house">
            <view class="pi-cell pi-hr-house">{{item.house}}</view>
            <view class="pi-cell pi-hr-sign">
              <view class="pi-icon-circle mini">
                <image class="pi-icon" src="{{item.signIcon}}" mode="aspectFit"></image>
              </view>
              <text class="pi-sign-name" style="color: {{item.signMeta.color}}">{{item.zhSign}}</text>
            </view>
            <view class="pi-cell pi-hr-ruler">
              <view class="pi-icon-circle mini">
                <text class="glyph-small" style="color: {{item.rulerMeta.color}}">{{item.rulerMeta.glyph}}</text>
              </view>
              <text class="pi-name">{{item.zhRuler}}</text>
            </view>
            <view class="pi-cell pi-hr-arrow"></view>
            <view class="pi-cell pi-hr-fly">
              <view class="fly-capsule">
                <text class="fly-arrow">→</text>
                <image class="pi-icon mini-fly" src="{{item.fliesToSignIcon}}" mode="aspectFit"></image>
                <text class="fly-text" style="color: {{item.fliesToSignMeta.color}}">{{item.zhFliesToSign}}</text>
                <text class="fly-house">{{item.fliesTo}}宫</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ========== 趋势预览层 ========== -->

    <!-- 8. 本周运势趋势 -->
    <view class="weekly-section card">
      <view class="card-header-row">
        <text class="card-title">本周趋势</text>
        <text class="card-subtitle">{{weekRange}}</text>
      </view>
      
      <!-- 柱状图 -->
      <view class="weekly-chart" wx:if="{{weeklyScores.length > 0}}">
        <view class="chart-bar-group" wx:for="{{weeklyScores}}" wx:key="date">
          <view class="chart-bar-wrapper">
          <view class="chart-bar" style="height: {{item.score}}%; background: {{item.barColor}}">
            <text class="bar-score" wx:if="{{item.score >= 60}}">{{item.score}}</text>
          </view>
            <text class="bar-score-below" wx:if="{{item.score < 60}}">{{item.score}}</text>
          </view>
          <text class="chart-day {{item.isToday ? 'today' : ''}}">{{item.day}}</text>
          <view class="chart-label" wx:if="{{item.label}}">
            <text class="label-icon">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 关键日期 -->
      <view class="key-dates" wx:if="{{weeklyEvents.length > 0}}">
        <view class="key-date-item" wx:for="{{weeklyEvents}}" wx:key="date">
          <view class="key-date-badge">
            <text class="key-date-icon">{{item.label || '重点'}}</text>
            <text class="key-date-day">{{item.date}}</text>
          </view>
          <text class="key-date-reason">{{item.description}}</text>
        </view>
      </view>
    </view>
      
  </view>

  <!-- 行星详情卡片 -->
  <view class="planet-detail-mask" wx:if="{{selectedPlanet}}" bindtap="closePlanetDetail"></view>
  <view class="planet-detail-card" wx:if="{{selectedPlanet}}" catchtap="stopProp">
    <view class="card-close" bindtap="closePlanetDetail">×</view>
    <view class="card-header">
      <view class="planet-glyph" style="color: {{selectedPlanet.color}};">{{selectedPlanet.glyph}}</view>
      <view class="planet-info">
        <view class="planet-name-row">
          <view class="planet-name" style="color: {{selectedPlanet.color}};">{{selectedPlanet.displayName}}</view>
          <view class="planet-badge">{{selectedPlanet.isRetrograde ? '逆行' : '顺行'}}</view>
        </view>
        <view class="planet-keywords" wx:if="{{selectedPlanet.keywords}}">{{selectedPlanet.keywords}}</view>
      </view>
    </view>

    <view class="card-section">
      <view class="section-label">星座位置</view>
      <view class="section-row">
        <view class="section-text">位于</view>
        <view class="sign-name" style="color: {{selectedPlanet.signColor}};">{{selectedPlanet.signName}}</view>
        <image class="sign-icon" src="{{selectedPlanet.signIcon}}" mode="aspectFit"></image>
        <view class="section-text">{{selectedPlanet.degree}}°{{selectedPlanet.minute}}'</view>
      </view>
    </view>

    <view class="card-section" wx:if="{{selectedPlanet.house}}">
      <view class="section-label">宫位信息</view>
      <view class="section-row">
        <view class="section-text">位于</view>
        <view class="house-num">{{selectedPlanet.house}}</view>
        <view class="section-text">宫</view>
        <block wx:if="{{selectedPlanet.ruledHouses}}">
          <view class="divider">|</view>
          <view class="section-text">守护</view>
          <view class="house-num">{{selectedPlanet.ruledHouses}}</view>
          <view class="section-text">宫</view>
        </block>
      </view>
    </view>

    <view class="card-section" wx:if="{{selectedPlanet.aspects && selectedPlanet.aspects.length > 0}}">
      <view class="section-label">主要相位</view>
      <view class="aspect-list">
        <view class="aspect-row" wx:for="{{selectedPlanet.aspects}}" wx:key="index">
          <view class="section-text">与</view>
          <view class="other-planet" style="color: {{item.otherColor}};">{{item.otherName}}</view>
          <view class="other-glyph" style="color: {{item.otherColor}};">{{item.otherGlyph}}</view>
          <view class="section-text">成</view>
          <view class="aspect-angle" style="color: {{item.aspectColor}};">{{item.angle}}°</view>
          <view class="aspect-symbol" style="color: {{item.aspectColor}};">{{item.aspectSymbol}}</view>
          <view class="aspect-orb">{{item.orb}}°</view>
          <view class="cross-badge" wx:if="{{item.isCross}}">跨盘</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 解读详情卡片 -->
  <view class="modal-mask" wx:if="{{detailCard}}" bindtap="closeDetailCard">
    <view class="modal-panel" catchtap="stopProp">
      <view class="close-btn" bindtap="closeDetailCard">×</view>
      <text class="modal-title">{{detailCard.title}}</text>
      <text class="modal-text" wx:if="{{detailCard.subtitle}}">{{detailCard.subtitle}}</text>
      <view class="detail-section" wx:for="{{detailCard.sections}}" wx:key="label">
        <text class="detail-label">{{item.label}}</text>
        <text class="detail-body">{{item.text}}</text>
      </view>
      <view class="detail-list" wx:if="{{detailCard.list && detailCard.list.length > 0}}">
        <text class="detail-label" wx:if="{{detailCard.listTitle}}">{{detailCard.listTitle}}</text>
        <view class="detail-list-item" wx:for="{{detailCard.list}}" wx:key="*this">
          <text class="detail-dot">·</text>
          <text class="detail-item-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.LOADING}}">
    <view class="card">
      <text class="loading-text">正在生成今日运势...</text>
    </view>
  </view>

  <view class="section" wx:if="{{status === LoadingState.ERROR}}">
    <view class="card">
      <text class="error-text">无法获取今日运势，请先完善出生信息。</text>
    </view>
  </view>
</view>
