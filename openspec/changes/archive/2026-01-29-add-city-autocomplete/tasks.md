## 1. 城市数据准备

### 1.1 创建城市数据文件
- [x] 1.1.1 创建 `miniprogram/data/cities.js` 文件
- [x] 1.1.2 收集中国大陆所有地级市数据（约 340 个）
  - 包含：城市名、省份名、拼音、经纬度
  - 格式：`{ name: '北京', province: '北京', country: '中国', pinyin: 'beijing', lat: 39.9, lon: 116.4 }`
- [x] 1.1.3 添加中国港澳台地区城市
  - 香港、澳门作为特别行政区
  - 台湾主要城市（台北、高雄等），国家标注为"中国"
- [x] 1.1.4 添加国际主要城市（约 100 个）
  - 覆盖主要国家首都和大城市
  - 包含英文名和中文名

### 1.2 数据结构设计
- [x] 1.2.1 设计城市数据结构
  ```javascript
  {
    id: 'beijing',
    name: '北京',
    province: '北京',
    country: '中国',
    pinyin: 'beijing',
    pinyinAbbr: 'bj',  // 拼音首字母
    lat: 39.9042,
    lon: 116.4074
  }
  ```
- [x] 1.2.2 生成拼音索引数据

## 2. 搜索工具开发

### 2.1 创建搜索工具
- [x] 2.1.1 创建 `miniprogram/utils/city-search.js`
- [x] 2.1.2 实现模糊搜索算法
  - 支持汉字匹配（包含匹配）
  - 支持拼音全拼匹配
  - 支持拼音首字母匹配
  - 支持英文名匹配
- [x] 2.1.3 实现匹配度评分算法
  - 完全匹配 > 前缀匹配 > 包含匹配
  - 城市名匹配 > 省份名匹配
- [x] 2.1.4 实现结果排序和限制（返回 3-5 个结果）

### 2.2 格式化工具
- [x] 2.2.1 实现城市显示格式化
  - 中国城市：`城市, 省份, 中国`
  - 国际城市：`城市, 州/省, 国家`
- [x] 2.2.2 实现逗号标准化（中英文逗号统一处理）
- [x] 2.2.3 实现用户输入自动匹配
  - 解析用户输入的城市字符串
  - 尝试匹配到标准城市数据
  - 返回匹配结果或原始输入

## 3. UI 组件开发

### 3.1 输入框组件改造
- [x] 3.1.1 修改 `synastry.wxml` 城市输入区域
  - 添加搜索结果下拉列表容器
  - 添加加载状态指示
- [x] 3.1.2 添加下拉列表样式 `synastry.wxss`
  - 下拉列表定位和样式
  - 列表项样式（城市名、省份、国家）
  - 选中状态样式
  - 空结果提示样式

### 3.2 交互逻辑实现
- [x] 3.2.1 修改 `synastry.js` 添加搜索逻辑
  - 输入防抖处理（300ms）
  - 调用搜索工具获取结果
  - 更新下拉列表数据
- [x] 3.2.2 实现下拉列表交互
  - 点击选择城市
  - 点击外部关闭下拉
  - 键盘上下选择（如支持）
- [x] 3.2.3 实现失焦自动匹配
  - 用户未选择直接离开时
  - 自动匹配最接近的城市
  - 更新输入框显示

## 4. 后台兼容处理

### 4.1 数据标准化
- [x] 4.1.1 在保存档案时标准化城市数据
  - 解析用户输入
  - 匹配标准城市
  - 存储标准化格式和经纬度
- [x] 4.1.2 兼容旧数据格式
  - 读取时尝试匹配旧格式
  - 自动升级为新格式

## 5. 验证与测试

- [x] 5.1 功能验证
  - 汉字搜索正确
  - 拼音搜索正确
  - 拼音首字母搜索正确
  - 英文搜索正确
- [x] 5.2 边界情况测试
  - 空输入处理
  - 无匹配结果处理
  - 特殊字符处理
  - 中英文逗号兼容
- [x] 5.3 性能验证
  - 搜索响应时间 < 100ms
  - 无明显卡顿
- [x] 5.4 数据验证
  - 台湾城市显示为"中国"
  - 港澳显示正确

## 依赖关系

- 任务 1.x（数据准备）必须先完成
- 任务 2.x（搜索工具）依赖 1.x
- 任务 3.x（UI 组件）依赖 2.x
- 任务 4.x 可与 3.x 并行
- 任务 5.x 依赖所有前置任务
