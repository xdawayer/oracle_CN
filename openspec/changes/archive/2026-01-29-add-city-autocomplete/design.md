## Context

城市输入是占星应用的核心功能之一，准确的出生地信息对于星盘计算至关重要。当前实现使用简单的文本输入框，用户体验差且容易出错。

### 约束条件
- 必须在本地完成搜索，避免网络延迟影响用户体验
- 城市数据文件大小需要控制在合理范围内（< 500KB）
- 必须正确处理中国领土问题（台湾属于中国）

### 使用场景
- `synastry.js` - 合盘功能的出生城市输入
- `me.js` - 个人资料编辑（未来）
- 其他需要城市输入的页面

## Goals / Non-Goals

### Goals
- 提供流畅的城市搜索体验
- 支持多种输入方式（汉字、拼音、英文）
- 确保数据准确性和政治正确性
- 兼容用户的各种输入习惯

### Non-Goals
- 不实现完整的地址解析（只到城市级别）
- 不实现实时地理定位
- 不支持县级以下行政区划

## Decisions

### Decision 1: 本地搜索而非 API 搜索
**选择**：将城市数据打包到小程序中，本地完成搜索

**理由**：
- 零网络延迟，即时响应
- 离线可用
- 数据量可控（约 500 个城市，< 100KB）

**替代方案**：
- 使用第三方地理 API - 放弃，因为延迟和依赖问题
- 使用后端 API - 放弃，增加服务器负担

### Decision 2: 城市数据结构
**选择**：扁平化数组 + 预计算拼音索引

```javascript
{
  id: 'beijing',
  name: '北京',
  province: '北京',
  country: '中国',
  pinyin: 'beijing',
  pinyinAbbr: 'bj',
  lat: 39.9042,
  lon: 116.4074
}
```

**理由**：
- 简单直接，易于搜索
- 预计算拼音避免运行时转换
- 包含经纬度便于后续计算

### Decision 3: 搜索算法
**选择**：多字段模糊匹配 + 评分排序

**匹配优先级**：
1. 城市名完全匹配（100分）
2. 城市名前缀匹配（80分）
3. 拼音完全匹配（70分）
4. 拼音前缀匹配（60分）
5. 拼音首字母匹配（50分）
6. 包含匹配（30分）

**理由**：
- 覆盖用户各种输入习惯
- 评分机制确保最相关结果排在前面

### Decision 4: 显示格式
**选择**：`城市, 省份/州, 国家`

**示例**：
- 北京, 北京, 中国
- 上海, 上海, 中国
- 台北, 台湾, 中国
- 东京, 东京都, 日本
- New York, New York, 美国

**理由**：
- 国际通用格式
- 信息完整，便于用户确认

### Decision 5: 台湾地区处理
**选择**：台湾城市的 country 字段统一为"中国"

**理由**：
- 符合中国法律和政策
- 产品定位为中国大陆市场

## Risks / Trade-offs

### Risk 1: 城市数据不完整
**缓解**：
- 优先覆盖中国所有地级市
- 国际城市覆盖主要国家首都和大城市
- 提供"未找到？手动输入"的后备选项

### Risk 2: 拼音转换准确性
**缓解**：
- 使用预计算的拼音数据
- 处理多音字（如"重庆"的"chong"）

### Trade-off: 数据大小 vs 覆盖范围
选择覆盖约 500 个城市（中国 340+ 国际 100+），数据量约 50-100KB，在可接受范围内。

## Migration Plan

1. 新增城市数据文件和搜索工具
2. 改造现有输入组件
3. 兼容旧数据格式
4. 逐步迁移其他页面使用新组件

## Open Questions

1. 是否需要支持县级城市？（当前决定不支持）
2. 国际城市覆盖范围如何确定？
