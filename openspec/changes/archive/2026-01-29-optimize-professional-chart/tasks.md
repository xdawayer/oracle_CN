# 专业排盘优化任务列表

## 阶段一：前端基础结构改造

### 任务 1.1：重构 chart.js 数据处理逻辑
**状态**: 已完成
**依赖**: 无
**优先级**: P0

**描述**:
从 `self.js` 和 `daily.js` 提取并复用数据处理函数：
- `buildElementMatrix()` - 构建元素矩阵数据
- `buildAspectMatrix()` - 构建相位矩阵数据
- `buildPlanetList()` - 构建行星列表数据
- `buildAsteroidList()` - 构建小行星列表数据
- `buildHouseRulers()` - 构建宫主星数据

**验证**:
- [x] 单人盘能正确生成以上所有数据结构
- [x] 双人盘能正确生成相位矩阵和行星信息

---

### 任务 1.2：添加用户选择模块的 UI
**状态**: 已完成
**依赖**: 无
**优先级**: P0

**描述**:
在排盘表单区域添加勾选框，让用户选择要显示的数据模块：
```javascript
data: {
  displayOptions: {
    chart: true,          // 星盘（默认勾选，不可取消）
    aspectMatrix: true,   // 相位矩阵
    planets: true,        // 行星信息
    asteroids: false,     // 小行星信息
    houseRulers: false,   // 宫主星信息
    elements: true,       // 元素信息（仅单人盘）
  }
}
```

**验证**:
- [x] 勾选框能正确显示
- [x] 双人盘时元素信息选项隐藏
- [x] 状态能正确保存到 data

---

### 任务 1.3：重构 chart.wxml 结果视图
**状态**: 已完成
**依赖**: 1.1, 1.2
**优先级**: P0

**描述**:
1. 添加星盘组件显示区域
2. 从 `self.wxml` 复制折叠面板结构
3. 根据 `displayOptions` 和盘型条件渲染各模块
4. 移除「查看详情」按钮

**验证**:
- [x] 星盘组件能根据盘型正确显示
- [x] 折叠面板能正常展开/收起
- [x] 各模块能根据用户选择显示/隐藏

---

### 任务 1.4：迁移样式到 chart.wxss
**状态**: 已完成
**依赖**: 1.3
**优先级**: P1

**描述**:
从 `self.wxss` 和 `daily.wxss` 复制所需样式：
- 折叠面板样式 (`.accordion-*`)
- 元素矩阵样式 (`.element-table`, `.el-*`)
- 相位矩阵样式 (`.aspect-matrix-*`, `.matrix-*`)
- 行星信息表格样式 (`.planet-info-table`, `.pi-*`)
- 宫主星表格样式 (`.pi-hr-*`)

**验证**:
- [x] 样式与「本我」页面保持一致
- [x] 无样式冲突或覆盖问题

---

## 阶段二：API 调用适配

### 任务 2.1：适配现有 API 返回数据
**状态**: 已完成
**依赖**: 1.1
**优先级**: P0

**描述**:
处理 `/api/natal/chart` 和 `/api/synastry/technical` 的返回数据，确保数据结构与展示组件匹配。

**验证**:
- [x] natal API 返回数据能正确渲染本命盘
- [x] synastry API 返回数据能正确渲染双轮盘

---

### 任务 2.2：行运盘数据整合
**状态**: 已完成
**依赖**: 2.1
**优先级**: P1

**描述**:
行运盘需要同时调用：
1. `/api/natal/chart` 获取本命盘数据
2. 计算当日行运数据（复用 daily 页面逻辑）

将两组数据整合为 `innerPositions` 和 `outerPositions`。

**验证**:
- [x] 行运盘能显示双轮盘（内环本命，外环行运）
- [x] 相位矩阵正确显示跨盘相位

---

### 任务 2.3：（可选）新增推运盘 API
**状态**: 已完成
**依赖**: 2.1
**优先级**: P2

**描述**:
如后端已支持，调用以下 API：
- `/api/progression/solar-return` - 太阳返照盘
- `/api/progression/secondary` - 次限盘
- `/api/progression/tertiary` - 三限盘

如未支持，暂时在前端显示「功能开发中」提示。

**验证**:
- [x] 推运盘能正确调用 API 并显示
- [x] 或正确显示开发中提示

---

## 阶段三：双人盘完善

### 任务 3.1：合盘比较盘 (synastry) 适配
**状态**: 已完成
**依赖**: 2.1
**优先级**: P0

**描述**:
使用 `synastry` 类型星盘组件，显示甲乙双方数据。

数据结构：
- `innerPositions`: 甲方行星位置
- `outerPositions`: 乙方行星位置
- `aspects`: 跨盘相位

**验证**:
- [x] 双轮盘正确显示甲乙双方
- [x] 相位矩阵显示跨盘相位
- [x] 行星信息分别列出甲方和乙方

---

### 任务 3.2：（可选）组合盘/时空盘适配
**状态**: 已完成
**依赖**: 3.1
**优先级**: P2

**描述**:
如后端支持，调用：
- `/api/composite/chart` - 组合盘
- `/api/davison/chart` - 时空盘

组合盘和时空盘虽然需要双人输入，但输出是单一盘面，使用 `natal` 类型显示。

**验证**:
- [x] 组合盘/时空盘能正确显示
- [x] 或正确显示开发中提示

---

## 阶段四：测试与优化

### 任务 4.1：功能测试
**状态**: 已完成
**依赖**: 3.1
**优先级**: P0

**描述**:
测试所有盘型的完整流程：
1. 本命盘 - 单人输入，单轮盘，显示元素矩阵
2. 行运盘 - 单人输入，双轮盘，显示元素矩阵
3. 合盘比较盘 - 双人输入，双轮盘，不显示元素矩阵

**验证**:
- [x] 所有核心盘型测试通过
- [x] 折叠面板交互正常
- [x] 用户选择项正确生效

---

### 任务 4.2：样式微调与响应式适配
**状态**: 已完成
**依赖**: 4.1
**优先级**: P1

**描述**:
- 确保在不同屏幕尺寸下显示正常
- 星盘组件尺寸自适应
- 表格在小屏幕上可横向滚动

**验证**:
- [x] iPhone SE 等小屏幕显示正常
- [x] iPad 等大屏幕布局合理

---

## 任务汇总

| 任务 ID | 名称 | 优先级 | 依赖 | 并行 |
|--------|------|--------|------|------|
| 1.1 | 重构数据处理逻辑 | P0 | - | 可与 1.2 并行 |
| 1.2 | 添加用户选择 UI | P0 | - | 可与 1.1 并行 |
| 1.3 | 重构结果视图 | P0 | 1.1, 1.2 | - |
| 1.4 | 迁移样式 | P1 | 1.3 | - |
| 2.1 | 适配现有 API | P0 | 1.1 | - |
| 2.2 | 行运盘数据整合 | P1 | 2.1 | - |
| 2.3 | 新增推运盘 API | P2 | 2.1 | 可与 2.2 并行 |
| 3.1 | 合盘比较盘适配 | P0 | 2.1 | - |
| 3.2 | 组合盘/时空盘适配 | P2 | 3.1 | - |
| 4.1 | 功能测试 | P0 | 3.1 | - |
| 4.2 | 样式微调 | P1 | 4.1 | - |

## 关键路径

```
1.1 + 1.2 (并行) → 1.3 → 1.4 → 2.1 → 2.2 → 3.1 → 4.1 → 4.2
                                    ↘ 2.3 (可选)
                                           ↘ 3.2 (可选)
```

## 验收清单

- [x] 本命盘能正确显示星盘 + 全部数据模块
- [x] 行运盘能正确显示双轮盘
- [x] 合盘比较盘能正确显示双人数据
- [x] 元素矩阵仅在单人盘显示
- [x] 折叠面板交互流畅
- [x] 用户选择的模块能正确显示/隐藏
- [x] 无 AI 调用，纯数据展示
- [x] 样式符合 COLOR_SYSTEM_GUIDE.md 规范
