# 优化星象问答：全屏报告模式

## 背景

当前 Ask（星象问答）模块采用聊天式交互，存在以下问题：

1. **问题选择交互不合理**：点击推荐问题后直接发起提问，用户无法修改或补充。应该是选择问题后填入输入栏，让用户确认或编辑后再发送。
2. **回答展示形式单一**：AI 回答直接显示在聊天气泡中，缺乏仪式感和专业感。应采用全屏报告形式，参考双人合盘的报告展示模式。
3. **缺少星盘可视化**：回答中没有展示与问题相关的星盘图，降低了内容的可信度和专业感。
4. **Prompt 内容结构不够清晰**：回答缺乏分层递进的逻辑结构。

## 变更目标

将 Ask 模块从"聊天式问答"升级为"问题输入 → 全屏报告"模式，使回答更专业、更有仪式感。

## 变更范围

### 前端（miniprogram）

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `pages/ask/ask.js` | MODIFIED | 重构交互逻辑：推荐问题填入输入栏、全屏报告展示 |
| `pages/ask/ask.wxml` | MODIFIED | 从聊天界面改为"问题输入 + 全屏报告"两步式 |
| `pages/ask/ask.wxss` | MODIFIED | 新增全屏报告样式，移除聊天气泡样式 |

### 后端（backend）

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/prompts/templates/ask/answer.ts` | MODIFIED | 重构 Prompt，输出结构化 JSON 报告（含星象依据层） |

### 不涉及的文件

- 后端 API 路由和 AI 服务层：接口契约不变，仅 Prompt 输出格式调整
- 星盘组件 `astro-chart`：复用现有组件，无需修改
- 配对页面集成：保留从 pairing 跳转的能力

## 核心设计

### 1. 交互流程变更

```
当前流程：
  选择目标 → 点击推荐问题 → 直接发送 → 聊天气泡显示回答

新流程：
  选择目标 → 点击推荐问题 → 问题填入输入栏 → 用户确认/编辑 → 发送
  → 全屏 loading → 全屏报告（星盘图 + 分层解读）
```

### 2. 全屏报告结构

参考 synastry 模块的报告展示模式（`showDeepOverlay`），报告采用全屏滚动页面：

```
┌──────────────────────────┐
│  ← 返回    星象问答报告   │  ← 顶部导航
├──────────────────────────┤
│                          │
│    ┌──────────────┐      │
│    │   星盘图     │      │  ← 本命盘 + 行运盘（根据问题类型）
│    │  (astro-chart) │    │
│    └──────────────┘      │
│                          │
│  ┌────────────────────┐  │
│  │ 问题回顾           │  │  ← 用户问题 + 咨询目标
│  │ "我的职业天赋..."  │  │
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │ 🌟 星象解读        │  │  ← 第一层：核心星象信息
│  │ 太阳白羊10宫...    │  │     与问题最相关的行星/宫位
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │ 💡 深度分析        │  │  ← 第二层：逐层递进分析
│  │ 1. 核心特质        │  │     2-3个维度的深度解读
│  │ 2. 当前行运        │  │
│  │ 3. 发展建议        │  │
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │ 🎯 行动建议        │  │  ← 第三层：具体可执行的建议
│  │ · 建议1           │  │
│  │ · 建议2           │  │
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │ 温暖寄语           │  │  ← 结尾：温暖收束
│  └────────────────────┘  │
└──────────────────────────┘
```

### 3. 星盘类型与问题的映射

| 问题类型 (category) | 星盘类型 | 重点标注 |
|---------------------|---------|---------|
| career（事业） | 本命盘 + 行运盘 | MC/10宫、6宫、2宫相关行星 |
| love（感情） | 本命盘 + 行运盘 | 金星、7宫、5宫、月亮相关 |
| growth（成长） | 本命盘 + 行运盘 | 太阳、上升、土星、冥王星 |
| social（社交） | 本命盘 + 行运盘 | 水星、11宫、3宫、7宫 |
| health（健康） | 本命盘 + 行运盘 | 6宫、1宫、月亮、火星 |

### 4. Prompt 输出格式变更

从纯文本改为结构化 JSON：

```json
{
  "astroContext": {
    "keyPlanets": ["太阳白羊10宫", "火星射手6宫"],
    "keyAspects": ["太阳拱木星", "火星刑土星"],
    "currentTransits": ["木星行运过5宫", "土星行运刑月亮"]
  },
  "sections": [
    {
      "type": "astro_insight",
      "title": "星象解读",
      "cards": [
        {
          "title": "核心配置",
          "content": "太阳落在白羊座第10宫...",
          "astroBasis": "太阳白羊10宫 拱 木星"
        }
      ]
    },
    {
      "type": "deep_analysis",
      "title": "深度分析",
      "cards": [
        {
          "title": "核心特质",
          "content": "...",
          "astroBasis": "..."
        },
        {
          "title": "当前运势影响",
          "content": "...",
          "astroBasis": "..."
        }
      ]
    },
    {
      "type": "action_plan",
      "title": "行动建议",
      "tips": ["具体建议1", "具体建议2", "具体建议3"]
    },
    {
      "type": "closing",
      "content": "温暖寄语..."
    }
  ]
}
```

## 风险评估

| 风险 | 级别 | 缓解措施 |
|------|------|---------|
| Prompt 输出格式从纯文本改为 JSON | 中 | 保留 JSON 修复逻辑；ai.ts 已有 RAW_TEXT_PROMPTS 配置可移除 ask-answer |
| 全屏报告 Canvas 层级问题 | 低 | 遵循 CLAUDE.md 中的 `wx:if` 隐藏规范 |
| 回答长度增加导致 token 消耗上升 | 低 | 控制各 section 字数上限 |

## 与已有工作的关系

- **延续** `archive/2026-01-29-optimize-ask-module` 的工作方向
- **复用** synastry 模块的报告展示模式和样式体系
- **不影响** refactor-prompt-architecture 的架构改动（仅修改 ask 模板内容）
