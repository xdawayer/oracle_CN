# love-topic-report Specification

## Purpose
爱情/婚恋专题深度解读报告，从爱情人格、理想伴侣、关系课题、未来运势四个维度为用户提供 2700-3500 字的深度感情分析。

## ADDED Requirements

### Requirement: 爱情专题报告生成

系统 SHALL 支持基于用户本命盘和行运数据生成爱情专题深度解读报告（reportType: `love-topic`）。

报告 SHALL 包含以下 4 个模块：
- 爱情人格画像（personality）：700-900 字
- 理想伴侣与关系模式（partner）：800-1000 字
- 关系课题与成长（growth）：600-800 字
- 未来12个月感情运势（forecast）：600-800 字

报告总字数 SHALL 在 2700-3500 字范围。

#### Scenario: 用户请求生成爱情专题报告
- **GIVEN** 用户已完成付费
- **AND** 用户本命盘数据已存在
- **WHEN** 用户请求生成爱情专题报告
- **THEN** 系统按 3 个批次启动模块生成
- **AND** 各模块完成后可逐个查看

#### Scenario: 与本命报告爱情模块的差异
- **GIVEN** 用户已有本命深度解读的 love 模块
- **WHEN** 用户购买爱情专题报告
- **THEN** 专题报告内容 SHALL 比本命报告更深入，包含理想伴侣画像、关系课题、未来行运等独立章节
- **AND** 不重复本命报告已有内容

---

### Requirement: 爱情相关星盘数据提取

系统 SHALL 从用户本命盘中提取以下爱情相关核心数据：

**本命数据**：
- 金星：星座、宫位、所有相位、是否逆行
- 火星：星座、宫位、所有相位
- 月亮：星座、宫位（情感基底）
- 第5宫：宫头星座、落入行星、宫主星位置
- 第7宫：宫头星座、落入行星、宫主星位置
- 第8宫：宫头星座、落入行星
- 北交点与南交点
- 相关特殊相位（金冥、月冥、金土、火冥等）

**可选数据**：
- Juno小行星：星座、宫位（若星历服务支持）
- 凯龙星与关系行星的相位（若可用）

**行运数据（未来12个月）**：
- 行运木星/金星过境5宫/7宫的时段
- 行运土星/冥王星过境7宫/8宫的时段
- 金星逆行时段
- 日月食落入关系轴线的日期

#### Scenario: 完整数据提取
- **GIVEN** 用户本命盘数据包含完整出生信息
- **WHEN** 系统启动爱情专题报告生成
- **THEN** 系统提取金星、火星、月亮、5/7/8宫、北交/南交等数据
- **AND** 计算未来12个月感情相关行运

#### Scenario: Juno不可用时降级
- **GIVEN** 星历服务不支持 Juno 小行星计算
- **WHEN** 系统提取爱情数据
- **THEN** Juno 字段标记为不可用
- **AND** partner 模块的"婚姻指针"章节通过7宫宫主星替代解读

---

### Requirement: 分批并行生成策略

系统 SHALL 按以下 3 个批次生成爱情专题模块：

- 批次 1（立即）：personality
- 批次 2（批次 1 完成后并行）：partner, growth
- 批次 3（批次 2 完成后）：forecast

forecast 模块 SHALL 在前序模块完成后最后生成，因为它需要综合前序发现来给出运势建议。

#### Scenario: 分批生成顺序
- **GIVEN** 用户请求生成报告
- **WHEN** personality 完成
- **THEN** 立即启动 partner 和 growth 的并行生成

#### Scenario: forecast 等待前序完成
- **GIVEN** personality、partner、growth 均已完成
- **WHEN** 系统启动 forecast 模块
- **THEN** forecast 的 prompt 上下文中 SHALL 包含前序模块的核心摘要

---

### Requirement: 爱情报告 Prompt 全局规则

爱情专题报告的 system prompt SHALL 在复用本命报告全局规则基础上，增加以下专属规则：

**角色补充**：专注于情感关系的占星师，温暖、有洞察力、不回避真实但始终充满善意。

**中国用户特化**：
- 适度描述"暧昧期""追求期"的表现
- 提及"见家长场景"的恋爱表现
- 提及中国婚恋文化特有关注点

**困难配置表达规则**：
- 每指出一个课题 SHALL 同时给出该课题带来的"礼物"
- 绝对禁止出现："你注定孤独""你不适合结婚"
- 使用成长视角：困难相位 = 张力 = 成长的来源

**差异化规则**：
- 行星解读必须结合相位增加独特性
- 罕见配置特别指出

#### Scenario: 困难相位温柔表达
- **GIVEN** 用户盘面有金星刑冥王星
- **WHEN** 系统生成 personality 或 growth 模块
- **THEN** 输出不 SHALL 包含"你的感情会不好"等负面表述
- **AND** 输出 SHALL 用成长视角描述，如"你在爱里渴望极致的深度和融合，这种渴望有时会变成张力，但它的礼物是你拥有深刻爱人的能力"

---

### Requirement: 质量校验

系统 SHALL 对爱情专题报告的每个模块进行自动质量校验：

- personality：字数 700-900，关键词 ['金星', '爱情|恋爱'] 至少命中 2 个
- partner：字数 800-1000，关键词 ['伴侣|另一半', '第7宫|七宫'] 至少命中 1 个
- growth：字数 600-800，关键词 ['课题|成长', '关系'] 至少命中 2 个
- forecast：字数 600-800，关键词 ['行运|过境', '桃花|感情'] 至少命中 1 个

全局禁止词：`注定孤独`, `不适合结婚`, `注定`, `劫难`, `你的盘很凶`

#### Scenario: 字数超范围触发重试
- **GIVEN** personality 模块目标字数为 700-900 字
- **WHEN** AI 生成了 1500 字的内容
- **THEN** 系统标记质量不合格
- **AND** 重新生成该模块（最多 1 次）

---

### Requirement: 报告缓存

爱情专题报告 SHALL 使用以下缓存策略：

- 任务记录 TTL：7 天
- 报告内容 TTL：60 天
- 缓存 key：`report:love-topic:{userId}:{moduleId}:{chartHash}`

#### Scenario: 缓存命中
- **GIVEN** 用户之前已生成过爱情专题报告
- **AND** 出生信息未变更
- **WHEN** 用户再次查看
- **THEN** 系统从缓存返回

---

### Requirement: 前端入口

"本我"页面 SHALL 在本命深度解读入口下方新增「专题深度报告」区域，包含爱情/事业/财富三个并列入口卡片。

爱情入口卡片 SHALL 使用粉红/玫瑰色调（主色 #E8A0BF）。

卡片 SHALL 显示：报告名称、简短描述、状态（未购买/生成中/已完成）。

点击 SHALL 跳转至 `/pages/report/report?reportType=love-topic`。

#### Scenario: 从本我页面进入爱情报告
- **GIVEN** 用户已购买爱情专题报告
- **AND** 报告已生成完成
- **WHEN** 用户点击爱情入口卡片
- **THEN** 跳转到报告页面并展示完整内容

#### Scenario: 三卡片并列布局
- **GIVEN** 用户进入"本我"页面
- **WHEN** 页面渲染专题报告区域
- **THEN** 爱情、事业、财富三个卡片水平并列显示
- **AND** 各自使用独立配色

---

### Requirement: 产品联动

forecast 模块结尾 SHALL 包含引导语，建议用户购买合盘报告以了解与具体对象的关系。

growth 模块结尾 MAY 包含引导语，建议用户通过 AI 问答深入探索具体课题。

#### Scenario: forecast 引导合盘
- **GIVEN** 系统生成 forecast 模块
- **WHEN** 内容生成完成
- **THEN** 结尾 SHALL 包含类似"想了解和某个具体对象的关系？可以体验合盘报告"的引导
