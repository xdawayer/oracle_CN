# 提案：微信小程序正式上架准备

## 背景

AstroMind（星智）微信小程序已完成核心功能开发，包括：
- 24 个页面路由，5 个 Tab Bar 主页面
- 微信授权登录 + JWT 自动续期
- 微信支付（VIP 订阅 + 积分充值）
- Canvas 2D 专业星盘绘制
- DeepSeek AI 内容生成
- 三层 Prompt 架构

现需为中国大陆微信小程序正式上架做最后准备，补齐合规、支付、审核所需的全部内容。

## 问题分析

### 一、隐私合规（P0 - 上架必需）

微信小程序自 2023 年 9 月起强制要求隐私保护，2024 年起进一步加严。当前缺失：

| 缺失项 | 影响 | 说明 |
|--------|------|------|
| `__private_config__` 隐私配置 | 审核被拒 | app.json 中未声明用户隐私收集清单 |
| 隐私政策页面 | 审核被拒 | 无独立隐私政策展示页 |
| 用户协议页面 | 审核被拒 | 无独立用户服务协议展示页 |
| 会员服务协议页面 | 支付合规缺失 | 订阅页仅有文字占位，无链接跳转 |
| 积分服务协议页面 | 支付合规缺失 | 充值页仅有文字占位，无链接跳转 |
| 隐私弹窗授权 | 审核被拒 | 首次使用时未弹出隐私授权确认 |
| 注销账号功能 | 审核被拒 | 2024 年起必须提供账号注销入口 |

### 二、微信支付完善（P0 - 上架必需）

当前微信支付已有基础框架，但缺少生产环境关键配置：

| 缺失项 | 影响 | 说明 |
|--------|------|------|
| 商户证书验签 | 支付安全漏洞 | 回调通知未完整验证微信平台证书 |
| 退款接口 | 合规要求 | 虚拟商品需提供退款通道 |
| 订单查询/管理 | 用户体验 | 用户无法查看历史订单 |
| 支付环境变量 | 无法发起支付 | MCH_ID/API_KEY_V3/PRIVATE_KEY 未配置 |
| 支付结果页 | 用户体验 | 支付成功/失败后无明确反馈页 |

### 三、小程序审核要求（P0 - 上架必需）

| 缺失项 | 影响 | 说明 |
|--------|------|------|
| 类目资质 | 审核被拒 | 占星类可能需要「生活服务-生活」或「工具」类目 |
| 内容安全审核 | 审核被拒 | AI 生成内容需接入微信内容安全 API (msgSecCheck) |
| 敏感词过滤 | 审核被拒 | 占星内容需避免"算命""预测未来"等敏感表述 |
| 版本描述 | 审核效率 | 提交审核时需准备功能说明和测试账号 |

### 四、生产环境准备（P1 - 建议完成）

| 缺失项 | 影响 | 说明 |
|--------|------|------|
| 数据库生产配置 | 数据丢失风险 | 当前 Supabase 配置被注释，使用内存回退 |
| HTTPS 域名配置 | 无法请求 | 小程序要求所有请求走 HTTPS 合法域名 |
| 服务器域名白名单 | 请求被拦截 | 需在小程序后台配置 request 合法域名 |
| 错误监控 | 线上无法排查 | 缺少异常上报机制 |
| sitemap.json 优化 | 隐私风险 | 当前允许所有页面被索引 |

## 变更范围

本提案涉及两个核心能力增量：

1. **compliance-and-legal**：隐私合规与法律文档
2. **payment-completion**：支付系统补全

## 不在范围内

- Stripe 国际支付（本次仅关注中国大陆微信支付）
- 新功能开发（仅补全上架所需内容）
- UI 改版（保持现有设计）
- 性能优化（除非影响审核）
