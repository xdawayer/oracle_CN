# 设计文档：微信小程序上架准备

## 架构决策

### AD-1：隐私合规方案

**决策**：采用微信小程序原生隐私保护框架 + 独立协议页面方案。

**方案说明**：
1. 使用 `__private_config__` 在 app.json 中声明隐私收集清单
2. 通过 `wx.onNeedPrivacyAuthorization` + `wx.requirePrivacyAuthorize` 触发隐私弹窗
3. 创建独立的协议页面（纯 WXML 富文本渲染），不依赖外部 WebView

**理由**：
- 微信原生隐私框架是审核的硬性要求
- 独立页面比 WebView 加载更快，且不需要额外域名配置
- 内容可直接内嵌在小程序包中，离线可用

### AD-2：协议页面架构

**决策**：创建一个通用协议页面组件，通过参数控制显示不同协议内容。

```
pages/agreement/agreement  ← 通用协议页面
  ?type=privacy        → 隐私政策
  ?type=terms          → 用户协议
  ?type=vip            → 会员服务协议
  ?type=points         → 积分服务协议
```

**理由**：
- 减少重复页面，一个页面模板服务四种协议
- 路由统一，方便管理和更新
- 协议内容存放在 `miniprogram/data/agreements.js` 中集中管理

### AD-3：账号注销方案

**决策**：在「我的」页面提供注销入口，二次确认后调用后端注销 API。

**流程**：
1. 我的页面 → 设置 → 注销账号
2. 弹窗提示注销后果（数据清除、VIP 失效等）
3. 二次确认（输入"确认注销"）
4. 调用 `/api/user/delete-account`
5. 清除本地缓存，跳转引导页

**理由**：
- 2024 年起微信审核强制要求注销功能
- 二次确认防止误操作
- 后端标记删除（软删除），保留 30 天恢复期

### AD-4：微信内容安全接入

**决策**：对 AI 生成内容在后端进行安全审核后再返回前端。

**方案**：
1. 后端调用 `security.msgSecCheck` 对 AI 输出进行文本安全检查
2. 对含敏感词的内容进行替换或过滤
3. 维护一个占星领域敏感词表（避免"算命""迷信"等表述）

**理由**：
- 微信对 UGC 和 AI 生成内容有安全审核要求
- 后端过滤比前端更安全可靠
- 占星内容需要特别注意措辞，避免被归类为"封建迷信"

### AD-5：微信支付证书管理

**决策**：使用微信支付 APIv3 SDK，证书文件存放在服务器安全目录。

**方案**：
1. 商户证书（apiclient_key.pem）存放在 `backend/certs/` 目录（git ignored）
2. 使用 `wechatpay-node-v3` 或自行实现 APIv3 签名
3. 平台证书自动下载和缓存

**理由**：
- APIv3 是微信支付当前推荐的接入方式
- 证书不入库，通过环境变量或安全文件路径引用
- 自动下载平台证书避免手动更新

### AD-6：退款方案

**决策**：实现基础退款接口，VIP 订阅按比例退款，积分未使用部分全额退款。

**退款规则**：
- VIP 订阅：购买 7 天内可申请退款，按剩余天数比例计算
- 积分充值：未消耗的积分可全额退款
- 退款到微信零钱，原路返回

**理由**：
- 虚拟商品退款是合规要求
- 7 天退款期平衡了用户权益和运营风险
- 原路返回是微信支付标准退款方式

## 数据流变化

### 隐私授权流程

```
用户首次打开 → onNeedPrivacyAuthorization 触发
  → 展示隐私弹窗（含协议链接）
  → 用户点击"同意" → requirePrivacyAuthorize
  → 正常使用小程序
  → 用户点击"拒绝" → 提示无法使用，保持弹窗
```

### 账号注销流程

```
我的页面 → 注销账号
  → 确认弹窗 → 输入"确认注销"
  → POST /api/user/delete-account
  → 后端软删除用户数据
  → 清除本地 token/缓存
  → 跳转 onboarding 页面
```

### 支付退款流程

```
我的页面 → 订单管理 → 选择订单 → 申请退款
  → 验证退款条件（时间/使用情况）
  → POST /api/wxpay/refund
  → 调用微信退款 API
  → 更新订单状态
  → 通知用户退款结果
```
