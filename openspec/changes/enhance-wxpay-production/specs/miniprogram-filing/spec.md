## ADDED Requirements

### Requirement: ICP 备案完成确认

系统上线前 SHALL 确保运营主体已完成 ICP 备案，并获得有效的 ICP 备案号。

备案信息 SHALL 在小程序「设置 → 基本设置 → 备案信息」中正确展示。

#### Scenario: ICP 备案号验证

- **GIVEN** 运营主体已完成工信部 ICP 备案
- **WHEN** 在微信公众平台提交小程序备案申请
- **THEN** ICP 备案号可通过工信部官网验证
- **AND** 备案主体与小程序运营主体一致

#### Scenario: ICP 备案未完成时阻断上线

- **GIVEN** 运营主体尚未完成 ICP 备案
- **WHEN** 尝试提交小程序备案
- **THEN** 备案申请将被驳回
- **AND** 需先完成 ICP 备案后再提交小程序备案

---

### Requirement: 小程序备案材料准备

运营方 SHALL 准备以下小程序备案所需材料：
- 营业执照（或个人身份证正反面，视主体类型而定）
- 法人/负责人身份证正反面照片
- 小程序负责人手持身份证照片
- 域名证书（如使用自有域名）
- 前置审批文件（如涉及特殊行业）
- 互联网信息服务承诺书（签字盖章扫描件）

占星类应用 SHALL 评估是否属于「网络文化经营」或「互联网宗教信息服务」范畴，如有需要应提前获取相应前置审批。

#### Scenario: 企业主体备案材料提交

- **GIVEN** 运营主体为企业
- **WHEN** 提交小程序备案申请
- **THEN** 上传营业执照、法人身份证、负责人信息等材料
- **AND** 填写企业基本信息（统一社会信用代码、注册地址等）
- **AND** 签署并上传互联网信息服务承诺书

#### Scenario: 个人主体备案材料提交

- **GIVEN** 运营主体为个人
- **WHEN** 提交小程序备案申请
- **THEN** 上传身份证正反面及手持身份证照片
- **AND** 完成人脸核验流程
- **AND** 签署互联网信息服务承诺书

#### Scenario: 占星内容前置审批评估

- **GIVEN** 小程序提供占星、星盘分析等服务
- **WHEN** 评估备案所需前置审批
- **THEN** 确认是否需要《网络文化经营许可证》
- **AND** 确认内容不涉及「互联网宗教信息服务」范畴
- **AND** 如需前置审批则在备案前完成申请

---

### Requirement: 域名白名单配置

小程序后端 API 使用的所有域名 SHALL 在微信公众平台「开发管理 → 开发设置 → 服务器域名」中完成白名单配置。

域名 SHALL 满足以下条件：
- 已完成 ICP 备案
- 使用 HTTPS 协议
- 不使用 IP 地址或 localhost
- 不使用端口号（仅 443）

#### Scenario: 配置 request 合法域名

- **GIVEN** 后端 API 部署在已备案域名上
- **WHEN** 在微信公众平台配置服务器域名
- **THEN** 将后端 API 域名添加至「request 合法域名」列表
- **AND** 域名使用 HTTPS 协议且已通过 ICP 备案验证

#### Scenario: 配置 uploadFile 合法域名

- **GIVEN** 小程序需要上传文件至服务器
- **WHEN** 配置服务器域名
- **THEN** 将文件上传接口域名添加至「uploadFile 合法域名」列表

#### Scenario: 非法域名配置被拒绝

- **GIVEN** 尝试配置未备案或使用 HTTP 协议的域名
- **WHEN** 在微信公众平台提交域名配置
- **THEN** 平台拒绝该配置并提示域名不合规
- **AND** 需先完成域名 ICP 备案或切换至 HTTPS

---

### Requirement: 备案流程跟踪

运营方 SHALL 跟踪小程序备案审核进度，备案流程包括：
1. 微信初审（约 1-2 个工作日）
2. 工信部短信核验（收到短信后 24 小时内完成）
3. 管局审核（约 5-20 个工作日，各省不同）

#### Scenario: 备案审核通过

- **GIVEN** 已提交完整的备案材料
- **WHEN** 经过微信初审、短信核验和管局审核
- **THEN** 备案状态变更为「已备案」
- **AND** 小程序获得备案号，可正常提交版本审核和上架

#### Scenario: 备案审核被驳回

- **GIVEN** 提交的备案材料存在问题
- **WHEN** 微信初审或管局审核发现问题
- **THEN** 收到驳回通知及具体驳回原因
- **AND** 根据驳回原因修正材料后重新提交

#### Scenario: 短信核验超时

- **GIVEN** 工信部已发送短信核验码
- **WHEN** 超过 24 小时未完成核验
- **THEN** 本次备案申请失效
- **AND** 需重新提交备案申请
