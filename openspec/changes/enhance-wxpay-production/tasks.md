## 1. 退款结果通知回调

- [x] 1.1 在 `wxpay.ts` 中新增 `POST /api/wxpay/refund-notify` 路由，使用 raw body 解析
- [x] 1.2 在 `wxpayService.ts` 中实现 `handleRefundNotify()`：验签 → 解密 → 更新订单状态为 `refunded` 或 `refund_failed`
- [x] 1.3 退款成功时回收对应权益（VIP 订阅：更新 subscription 结束时间；积分：扣减 purchase_records 中未消费余额）
- [x] 1.4 退款失败时记录日志并保持订单原状态，不影响用户权益

## 2. API 调用重试机制

- [x] 2.1 封装 `wxpayRequest()` 通用请求函数，包含指数退避重试（最多 3 次，间隔 1s/2s/4s）
- [x] 2.2 仅对网络错误和 5xx 状态码重试，4xx 错误直接返回
- [x] 2.3 将 `createOrder()`、`refundOrder()`、`queryOrder()` 中的 HTTP 调用替换为 `wxpayRequest()`

## 3. 主动订单状态查询

- [x] 3.1 在 `wxpayService.ts` 中实现 `queryWxPayOrder(outTradeNo)` 调用微信查询订单 API
- [x] 3.2 在 `wxpay.ts` 中新增 `POST /api/wxpay/query-order` 端点，供前端主动触发查询
- [x] 3.3 前端 pending 订单显示"查询支付结果"按钮，点击调用该端点

## 4. 订单超时自动关闭

- [x] 4.1 在 `wxpayService.ts` 中实现 `closeExpiredOrders()` 函数：查询超过 30 分钟仍为 pending 的订单，调用微信关闭订单 API 并更新状态为 `closed`
- [x] 4.2 使用 `setInterval` 每 10 分钟执行一次（服务启动时注册）
- [x] 4.3 关闭订单前先调用微信查询 API 确认订单确实未支付

## 5. 平台证书管理完善

- [x] 5.1 平台证书下载成功后写入 `backend/certs/` 目录作为本地持久化缓存
- [x] 5.2 服务启动时优先从本地文件加载证书，减少对微信 API 的依赖
- [x] 5.3 内存缓存过期（24 小时）后重新从微信下载并更新本地文件
- [x] 5.4 确保 `backend/certs/` 目录在 `.gitignore` 中

## 6. 前端退款状态更新

- [x] 6.1 订单列表页增加 `refund_failed` 状态展示（红色标签"退款失败"）
- [x] 6.2 订单列表页增加 `closed` 状态展示（灰色标签"已关闭"）
- [x] 6.3 退款失败的订单显示"联系客服"提示

## 7. ICP 备案与小程序备案

> 运营/行政任务，需人工在微信公众平台和工信部网站操作。

- [ ] 7.1 确认运营主体 ICP 备案状态，在工信部官网核验备案号有效性
- [ ] 7.2 准备小程序备案所需材料（营业执照/身份证、法人信息、负责人信息、承诺书等）
- [ ] 7.3 评估占星类内容是否需要前置审批（网络文化经营许可证、互联网宗教信息服务等），如需则提前申请
- [ ] 7.4 在微信公众平台提交小程序备案申请，上传全部材料
- [ ] 7.5 完成工信部短信核验（收到短信后 24 小时内）
- [ ] 7.6 跟踪管局审核进度，如被驳回则根据原因修正后重新提交

## 8. 域名白名单与合规配置

> 运营/配置任务，需在微信公众平台后台操作。代码中已正确区分开发/生产环境。

- [ ] 8.1 确认后端 API 域名已完成 ICP 备案且使用 HTTPS
- [ ] 8.2 在微信公众平台「开发管理 → 服务器域名」中配置 request 合法域名
- [ ] 8.3 如有文件上传需求，配置 uploadFile 合法域名
- [x] 8.4 移除开发环境中所有 `localhost` 和 IP 直连调用，确保生产环境仅通过白名单域名访问（已确认：生产环境使用 `https://api.astromind.com`，仅开发环境使用 `127.0.0.1`）
- [ ] 8.5 验证小程序在关闭「不校验合法域名」选项后所有网络请求正常工作
