# 能力规范：manage-me-page

管理「我的」页面模块的完整体验，包括个人中心、资料编辑、VIP 订阅、积分充值、收藏与合盘记录。

---

## ADDED Requirements

### Requirement: 我的主页展示用户概览信息

「我的」主页应展示用户头像、昵称、VIP 状态、统计数据（积分/收藏/合盘）和功能菜单入口。

- 所有功能入口均通过页面跳转实现，不使用页面内子视图切换
- 统计数据从后端获取并缓存到本地
- 页面每次 `onShow` 时刷新数据

#### Scenario: 已登录 VIP 用户查看我的主页

- **GIVEN** 用户已登录且为 VIP 会员
- **WHEN** 用户进入「我的」页面
- **THEN** 显示用户头像和昵称
- **AND** 显示「尊享会员」标签
- **AND** 会员卡片显示到期日期
- **AND** 统计区显示积分数、收藏数、合盘数
- **AND** 菜单列表显示：编辑出生资料、偏好设置、帮助与反馈、退出登录

#### Scenario: 未登录用户查看我的主页

- **GIVEN** 用户未登录
- **WHEN** 用户进入「我的」页面
- **THEN** 显示默认头像和「星智用户」昵称
- **AND** 不显示 VIP 标签
- **AND** 会员卡片显示「开通会员」提示
- **AND** 统计区数值为 0

---

### Requirement: 个人资料编辑页支持完整信息修改

用户可在个人资料编辑页修改头像、昵称、出生日期、出生时间和出生城市。

- 头像支持微信头像获取和相册选择
- 出生信息编辑复用 onboarding 的交互模式（日期选择器、时间选择器、城市搜索）
- 保存后同步更新后端和本地缓存

#### Scenario: 用户修改昵称并保存

- **GIVEN** 用户在个人资料编辑页
- **WHEN** 用户修改昵称为「星小白」并点击保存
- **THEN** 调用 `PUT /api/user/profile` 接口
- **AND** 保存成功后显示提示
- **AND** 返回我的主页时昵称已更新

#### Scenario: 用户更换头像

- **GIVEN** 用户在个人资料编辑页
- **WHEN** 用户点击头像区域
- **THEN** 弹出选择方式（拍照/从相册选择）
- **AND** 选择图片后上传到 `POST /api/user/avatar`
- **AND** 上传成功后头像即时更新

---

### Requirement: VIP 会员中心展示订阅方案并支持购买

VIP 会员中心页展示三档订阅方案、会员权益列表，并支持通过微信支付完成订阅。

- 三档方案：连续包月 ¥9.9（原价 ¥30）、年度会员 ¥128（原价 ¥360，标签「最超值」）、季度会员 ¥45（原价 ¥90）
- 默认选中年度会员
- 底部固定购买按钮，按钮文案随选中方案变化
- 必须勾选《会员服务协议》才能购买

#### Scenario: 非 VIP 用户开通年度会员

- **GIVEN** 用户未开通 VIP
- **WHEN** 用户进入 VIP 会员中心
- **THEN** 页面显示三档方案，年度会员默认选中
- **AND** 按钮显示「开通会员 ¥128」
- **WHEN** 用户勾选协议并点击按钮
- **THEN** 调用 `/api/wxpay/create-order`（orderType: subscription, plan: yearly）
- **AND** 调用 `wx.requestPayment` 发起微信支付
- **AND** 支付成功后跳转回会员中心，显示 VIP 状态已激活

#### Scenario: 已订阅用户续费

- **GIVEN** 用户已是 VIP 会员，到期日期为 2026-12-31
- **WHEN** 用户进入 VIP 会员中心
- **THEN** 页面头部显示当前到期日期
- **AND** 按钮文案为「续费会员 ¥128」
- **WHEN** 用户完成续费支付
- **THEN** 到期日期在原有基础上叠加

---

### Requirement: 积分充值页支持多档充值并通过微信支付

积分充值页展示当前余额和六档充值选项，支持微信支付完成充值。

- 六档：1积分/¥1、10积分/¥10、50积分/¥50（热门）、100积分/¥100、200积分/¥200、500积分/¥500（推荐）
- 默认选中 50 积分
- 支持余额刷新
- 右上角入口跳转积分记录页

#### Scenario: 用户充值 50 积分

- **GIVEN** 用户当前积分余额为 8422
- **WHEN** 用户选中 50 积分档位并点击支付
- **THEN** 调用 `/api/wxpay/create-order`（orderType: points, amount: 50, totalFee: 5000）
- **AND** 调用 `wx.requestPayment` 发起微信支付
- **AND** 支付成功后余额刷新为 8472

#### Scenario: 余额刷新

- **GIVEN** 用户在积分充值页
- **WHEN** 用户点击余额旁的刷新按钮
- **THEN** 调用后端接口获取最新余额
- **AND** 页面显示最新积分数

---

### Requirement: 积分记录页展示收支明细

积分记录页以表格形式展示用户的积分收支流水。

- 表格列：详情（描述）、日期、积分变更
- 正数（充值/奖励）显示绿色，负数（消耗）显示默认色
- 支持分页加载（下拉触底加载更多）

#### Scenario: 用户查看积分记录

- **GIVEN** 用户有充值和消耗记录
- **WHEN** 用户进入积分记录页
- **THEN** 按时间倒序展示记录列表
- **AND** 充值记录显示为绿色 +N
- **AND** 消耗记录显示为默认色 -N

#### Scenario: 滚动加载更多

- **GIVEN** 用户有超过一页的记录
- **WHEN** 用户滚动到页面底部
- **THEN** 自动加载下一页数据
- **AND** 加载完成后追加到列表底部

---

### Requirement: 收藏报告页展示已收藏报告并支持查看详情

收藏报告页展示用户收藏的所有类型报告，支持按类型筛选和查看详情。

- 报告卡片显示：类型标签、标题、摘要、日期、「点击查看详情」入口
- 报告类型：双人合盘、每日运势、本命解读、占星实验等

#### Scenario: 用户查看收藏报告列表

- **GIVEN** 用户有 3 份收藏报告
- **WHEN** 用户进入收藏报告页
- **THEN** 按日期倒序展示 3 张报告卡片
- **AND** 每张卡片显示类型标签、标题、摘要和日期

---

### Requirement: 合盘记录页展示历史合盘分析

合盘记录页展示用户历史的双人合盘分析记录。

- 记录卡片显示：匹配分数、双方姓名、关系类型标签、日期
- 点击卡片查看合盘详情

#### Scenario: 用户查看合盘记录列表

- **GIVEN** 用户有 2 条合盘记录
- **WHEN** 用户进入合盘记录页
- **THEN** 按日期倒序展示 2 张记录卡片
- **AND** 每张卡片显示匹配分数（如 88 PTS）、双方姓名（我 & 林悦）、关系类型标签（恋人）和日期

---

### Requirement: 所有子页面采用统一水墨极简视觉风格

所有「我的」模块子页面 SHALL 遵循统一的东方禅意水墨极简设计规范。

- 背景色使用 `--paper-100`
- 卡片背景使用 `--paper-50` + `ink-border`
- 文字使用 `--ink-deep`（主要）/ `--ink-dark`（次要）/ `--ink-light`（弱化）
- 操作按钮使用 `--accent` 金色或 `--ink-deep` 深墨色
- 标题使用 `font-ancient` 字体
- 禁止使用粉红色、金棕色渐变、彩色图标背景、emoji
- 所有页面使用原生导航栏，禁止自定义重复导航栏

#### Scenario: 视觉一致性验证

- **GIVEN** 用户从「我的」主页依次进入各子页面
- **WHEN** 查看每个子页面的视觉风格
- **THEN** 所有页面使用相同的配色方案（黑白为主）
- **AND** 卡片、文字、按钮风格保持一致
- **AND** 无非规范配色出现

---

### Requirement: 微信支付后端完整对接

后端 SHALL 实现微信支付 JSAPI 支付的完整流程。

- 统一下单接口生成预付单
- 支付参数签名使用 RSA-SHA256
- 回调验签确保安全
- 订单幂等处理（同一订单重复回调不重复入账）
- 支付渠道标记为 `wechat`，与现有 Stripe 系统共存

#### Scenario: VIP 订阅支付全流程

- **GIVEN** 微信支付商户号已配置
- **WHEN** 前端请求创建 VIP 年度订阅订单
- **THEN** 后端生成预付单并返回签名参数
- **AND** 微信支付成功回调后更新用户 VIP 状态
- **AND** 订单状态标记为已完成

#### Scenario: 积分充值支付全流程

- **GIVEN** 微信支付商户号已配置
- **WHEN** 前端请求创建 50 积分充值订单
- **THEN** 后端生成预付单（金额 5000 分 = ¥50.00）
- **AND** 微信支付成功回调后积分余额增加 50
- **AND** 积分流水记录已写入
