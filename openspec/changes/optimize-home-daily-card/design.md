# Design: 首页运势卡片内容与分享优化

## Context

首页运势卡片是用户打开小程序的第一眼内容，当前由前端本地字典（MOON_THEME + ASPECT_HINT）生成文案，内容较为固定。需引入 AI 生成的金句+正文提升吸引力，同时重构分享弹窗支持真正的社交传播。

## Goals / Non-Goals

**Goals**:
- 引入 AI 生成的金句（12-18字）+ 正文（40-60字），替代本地固定文案
- 重构分享弹窗为全屏精美卡片，支持复制和微信分享
- 保持首页加载速度（transit 端点 < 200ms）

**Non-Goals**:
- 不改变运势评分计算逻辑（仍由前端 MOON_THEME + ASPECT_HINT 计算）
- 不重构推荐系统或其他首页模块
- 不实现海报图片生成（仅文字分享）

## Decisions

### 1. AI 内容生成策略

**决策**：transit 端点并行调用 AI 生成金句，设 2 秒超时，超时则回退本地文案。

**替代方案**：
- A) 仅前端本地字典 → 文案固定无变化，pass
- B) 独立 API 端点 → 额外请求增加前端复杂度
- C) 预生成缓存 → 需额外定时任务基础设施

**理由**：并行调用不阻塞 transit 计算（< 50ms），2 秒超时足够 DeepSeek 返回短文本。缓存 key 按日期+星象 hash，同一天同一星象只生成一次。

### 2. Prompt 设计

**决策**：新增独立模板 `daily-home-card`，与 `daily-forecast` 分离。

**理由**：
- `daily-forecast` 输出完整 JSON（评分、维度、建议等），结构复杂
- 首页卡片只需金句+正文，独立模板更精简、token 消耗更低
- 可独立调优，不影响详情页内容

### 3. 分享实现方式

**决策**：文字复制 + 微信原生分享，不生成海报图片。

**替代方案**：
- Canvas 生成海报图片 → 实现复杂，微信小程序 Canvas 有原生组件层级问题
- 服务端渲染图片 → 需额外基础设施

**理由**：MVP 阶段文字分享足够，用户可截图分享。后续可迭代增加海报生成。

## Risks / Trade-offs

- **AI 延迟风险**：transit 端点原本 < 50ms，加入 AI 调用后可能增至 1-2 秒
  - 缓解：前端先用本地文案渲染卡片，AI 内容返回后替换（渐进增强）
- **Token 成本**：每次首页加载触发一次短文本生成
  - 缓解：按日期+星象 hash 缓存，同一天大量用户共享同一缓存

## Open Questions

- 是否需要在分享卡片中显示小程序码？当前设计图有此元素，但需确认小程序码获取方式。
